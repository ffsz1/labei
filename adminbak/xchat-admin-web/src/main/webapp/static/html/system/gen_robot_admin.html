<section class="content">
    <div class="box box-primary">
        <div class="box-body">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1 id="itemTitle"></h1>
            </section>
            <!-- .content -->
            <section class="content">
                <div id="table"></div>
                <div id="toolbar">
                    <button id="gen" class="btn btn-info">
                        <i class="glyphicon glyphicon-circle-arrow-down"></i> 批量生成机器人
                    </button>
                    <button id="generate" class="btn btn-danger">
                        <i class="glyphicon glyphicon-circle-arrow-down"></i> 批量生成水军
                    </button>
                    <!-- <button id="insert" class="btn btn-primary">
                        <i class="glyphicon glyphicon-circle-arrow-down"></i> 批量生成厅主号
                    </button> -->
                    <button id="add" class="btn btn-warning">
                        <i class="glyphicon glyphicon-plus"></i> 添加机器人
                    </button>
                    <button id="modify" class="btn">
                        <i class="glyphicon glyphicon-edit"></i> 批量修改密码
                    </button>
                </div>
            </section>
        </div>
    </div>
</section>
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel2">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">x</span>
                </button>
                <h4 class="modal-title" id="addModalLabel">操作机器人信息</h4>
            </div>
            <div class="modal-body">
                <form id="edit" class="form-horizontal">
                    <input type="hidden" name="id" id="id">
                    <div class="form-group">
                        <label for="editNick" class="col-sm-3 control-label">昵称:</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control validate[required]" name="nick" id="editNick">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editGender" class="col-sm-3 control-label">性别:</label>
                        <div class="col-sm-8">
                            <select name="gender" id="editGender" class="col-sm-2">
                                <option value="1">男</option>
                                <option value="2">女</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">机器人头像图:</label>
                        <div class="col-sm-8">
                            <img src="" id="addImgUrl" style="width:70px;height:70px;" alt="">
                            <input type="file" id="addUploadFile" name="uploadFile"
                                   accept="image/gif,image/jpeg,image/jpg,image/png,image/svg">
                            <button class="btn btn-success" type="button" id="editUploadBtn">上传</button>
                            <input type="hidden" id="editAvatar" name="avatar" class="form-control validate[required]"/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="editSave">保存</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="tipModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">提示信息</h4>
            </div>
            <div class="modal-body" id="tipMsg"></div>
        </div>
    </div>
</div>
<div class="modal fade" id="editableModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="modalsLabel">修改密码</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="editableForm">
                    <div class="form-group">
                        <label for="password" class="col-sm-3 control-label">密码:</label>
                        <div class="col-sm-8">
                            <input type="text" id="password" class="form-control validate[required]" name="password">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirm">确定</button>
            </div>
        </div>
    </div>
</div>
<script src="../../static/js/ajaxfileupload.js"></script>
<script>
    $(function () {
        $('#table').bootstrapTable('destroy');
        $('#table').bootstrapTable({
            columns: [
                {field: 'checked', checkbox: true},
                {field: 'id', title: 'ID', align: 'center', width: 300, visible: false},
                {field: 'nick', title: '昵称', align: 'center', width: 300},
                {field: 'password', title: '密码', align: 'center', width: 300},
                {
                    field: 'avatar', title: '图片', align: 'center', width: 300, formatter: function (val, row, index) {
                        return "<img src='" + val + "' width='70'>";
                    }
                },
                {
                    field: 'gender',
                    title: '性别',
                    align: 'center',
                    valign: 'middle',
                    width: 300,
                    formatter: function (val, row, index) {
                        if (val == 1) {
                            return '男';
                        } else {
                            return '女';
                        }
                    }
                },
                {
                    field: 'isUsed',
                    title: '是否使用',
                    align: 'center',
                    width: 300,
                    formatter: function (val, row, index) {
                        if (val == 1) {
                            return '是';
                        } else if (val == 0) {
                            return '否';
                        }
                    }
                },
                {
                    field: 'id',
                    title: '操作',
                    align: 'center',
                    width: 400,
                    valign: 'middle',
                    formatter: function (val, row) {
                        return "<button class='btn btn-success opt-edit' data-id=" + row.id + "><i class='glyphicon glyphicon-edit'></i> 编辑</button>";
                    }
                }
            ],
            cache: false,
            striped: true,
            showRefresh: true,
            pageSize: 10,
            pagination: true,
            pageList: [1, 10, 20, 30, 50],
            search: false,
            sidePagination: "server",
            // 设置为undefined可以获取pageNumber, pageSize, searchText, sortName, sortOrder
            // 设置为limit可以获取limit, offset, search, sort, order
            queryParamsType: "undefined",
            queryParams: function queryParams(params) {
                const param = {
                    pageNumber: params.pageNumber,
                    pageSize: params.pageSize
                };
                return param;
            },
            toolbar: '#toolbar',
            url: '/auto/gen/robot/getList.action',
            onLoadSuccess: function () {
                console.log("load success");
            },
            onLoadError: function () {
                console.log("load fail");
            }
        });
        $("#cancel").click(function () {
            TableHelper.unCheckAll("#table");
        });
        // 生成机器人
        $('#gen').on('click', function () {
            $.ajax({
                type: 'post',
                url: '/auto/gen/robot/gen',
                data: {
                    type: 1
                },
                dataType: 'json',
                success: function (res) {
                    if (res.code == 200) {
                        $("#tipMsg").text("生成机器人成功");
                        $("#tipModal").modal('show');
                    } else {
                        $("#tipMsg").text("参数错误");
                        $("#tipModal").modal('show');
                    }
                }
            })
        });
        // 生成水军
        $('#generate').on('click', function () {
            $.ajax({
                type: 'post',
                url: '/auto/gen/robot/gen',
                data: {
                    type: 2
                },
                dataType: 'json',
                success: function (res) {
                    if (res.code == 200) {
                        $("#tipMsg").text("生成水军成功");
                        $("#tipModal").modal('show');
                    } else {
                        $("#tipMsg").text("参数错误");
                        $("#tipModal").modal('show');
                    }
                }
            })
        });
        // 生成厅主号
        $('#insert').on('click', function () {
            $.ajax({
                type: 'post',
                url: '/auto/gen/robot/gen',
                data: {
                    type: 3
                },
                dataType: 'json',
                success: function (res) {
                    if (res.code == 200) {
                        $("#tipMsg").text("生成水军成功");
                        $("#tipModal").modal('show');
                    } else {
                        $("#tipMsg").text("参数错误");
                        $("#tipModal").modal('show');
                    }
                }
            })
        });
        // 添加机器人
        $('#add').on('click', function () {
            $("#editModal").modal("show");
            $("#id").val("");
            $("#addImgUrl").attr("src", "");
            $("#edit")[0].reset();
        });
        // 批量修改密码
        $('#modify').on('click', function () {
            const selected = $('#table').bootstrapTable('getSelections');
            console.log(JSON.stringify(selected));
            if (JSON.stringify(selected) == '[]') {
                $("#editableModal").modal('hide');
                $("#tipMsg").text("请选择要修改密码的账户");
                $("#tipModal").modal('show');
            } else {
                $('#editableModal').modal('show');
                $('#password').val('');
            }
        });
        // 确认批量修改密码
        $('#confirm').on('click', function () {
            const selected = $('#table').bootstrapTable('getSelections');
            console.log($('#password').val().length)
            if ($('#password').val().length < 6) {
                $("#editableModal").modal('hide');
                $("#tipMsg").text("密码要大于6位");
                $("#tipModal").modal('show');
                return;
            }
            let ids = '';
            for (let i = 0; i < selected.length; i++) {
                ids += selected[i].id + ",";
            }
            if (!ids) {
                return;
            }
            ids = ids.substr(0, ids.length - 1);
            $.post("/auto/gen/robot/modifiedPassword", {robotIds: ids, password: $('#password').val()}, function (data) {
                $("#editableModal").modal('hide');
                if (data.code == 200) {
                    $("#tipMsg").text("批量修改密码成功");
                    $("#tipModal").modal('show');
                    TableHelper.doRefresh("#table");
                } else {
                    $("#tipMsg").text("批量修改密码失败");
                    $("#tipModal").modal('show');
                }
            })
        });
        // 编辑按钮
        $('#table').on('click', '.opt-edit', function () {
            const id = $(this).data('id');
            if (id) {
                $("#editModal").modal('show');
                $.get("/auto/gen/robot/getOne", {id: id}, function (data) {
                    if (data.code == 200) {
                        $("#id").val(data.data.id);
                        $("#editNick").val(data.data.nick);
                        $('#editGender').val(data.data.gender);
                        $('#addImgUrl').attr('src', data.data.avatar);
                        $("#editAvatar").val(data.data.avatar);
                        $("#editSave").removeAttr("disabled");
                    }
                })
            }
        });
        // 操作保存按钮
        $('#editSave').on('click', function () {
            $("#editSave").attr("disabled", true);
            if (!$("#edit").validationEngine('validate')) {
                $("#editSave").removeAttr("disabled");
                return;
            }

            const isEdit = $("#id").val() == '' ? false : true;
            $.ajax({
                type: "post",
                url: "/auto/gen/robot/create",
                data: {
                    id: $('#id').val(),
                    nick: $('#editNick').val(),
                    gender: $('#editGender').val(),
                    avatar: $('#editAvatar').val(),
                    isEdit: isEdit
                },
                dataType: 'json',
                success: function (res) {
                    if (res.code == 200) {
                        $("#editModal").modal('hide');
                        $("#tipMsg").text("保存成功");
                        $("#tipModal").modal('show');
                        TableHelper.doRefresh("#table");
                    } else {
                        $("#tipMsg").text("保存失败，错误码：" + res.code);
                        $("#tipModal").modal('show');
                    }
                }
            })
        });
        // 上传头像
        $('#editUploadBtn').on('click', function () {
            const options = {
                type: 'post',
                url: '/admin/banner/headimg.action',
                dataType: 'json',
                success: function (json) {
                    if (json.path) {
                        $('#editAvatar').val(json.path);
                        $('#addImgUrl').attr("src", json.path);
                        console.log(json.path);
                    } else {
                        $("#tipMsg").text(json.msg);
                        $("#tipModal").modal('show');
                    }
                }
            };
            $("#edit").ajaxSubmit(options);
        });
    });
</script>
