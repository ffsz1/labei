<section class="content">
    <div class="box box-primary">
        <div class="box-body">
            <section class="content-header">
                <h1 id="itemTitle"></h1>
            </section>
            <section class="content">
                <div id="table"></div>
                <div id="toolbar">
                    <button id="add" class="btn btn-primary">
                        <i class="glyphicon glyphicon-plus"></i> 增加
                    </button>
                </div>
            </section>
        </div>
    </div>
</section>
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">x</span></button>
                <h4 class="modal-title" id="editModalLabel">新增版本</h4>
            </div>
            <div class="modal-body">
                <form id="channelForm" class="form-horizontal">
                    <input type="hidden" name="id" id="id">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">系统:</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control validate[required]" id="os" name="os">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">App版本:</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control validate[required]" id="appVersion"
                                   name="appVersion">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="save">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="../../static/js/ajaxfileupload.js"></script>
<script>
    $(function () {
        $('#table').bootstrapTable('destroy');
        $('#table').bootstrapTable({
            cache: false,
            striped: true,
            showRefresh: false,
            pageSize: 10,
            pagination: true,
            pageList: [10, 20, 30, 50],
            sidePagination: "server", //表示服务端请求
            //设置为undefined可以获取pageNumber，pageSize，searchText，sortName，sortOrder
            //设置为limit可以获取limit, offset, search, type, order
            queryParamsType: "undefined",
            queryParams: function queryParams(params) {   //设置查询参数
                var param = {
                    pageSize: params.pageSize,
                    pageNumber: params.pageNumber
                };
                return param;
            },
            uniqueId: 'id',
            toolbar: '#toolbar',
            url: '/admin/AppSecret/list',
            onLoadSuccess: function () {  //加载成功时执行
                console.log("load success");
            },
            onLoadError: function () {  //加载失败时执行
                console.log("load fail");
            },
            columns: [
                {field: 'os', title: '系统', align: 'center', valign: 'middle', width: 300},
                {field: 'appVersion', title: 'app版本', align: 'center', valign: 'middle', width: 300},
                {field: 'signKey', title: '版本密钥', align: 'center', valign: 'middle', width: 300},
                {
                    field: 'createTime', title: '创建时间', align: 'center', valign: 'middle', width: 350,
                    formatter: function (val) {
                        if (val) {
                            const date = new Date(val);
                            return date.format("yyyy-MM-dd HH:mm:ss");
                        } else {
                            return '-';
                        }
                    }
                },
                {
                    field: 'signKey', title: '操作', align: 'center', width: 350, valign: 'middle',
                    formatter: function (val) {
                        const str = "<button class='btn btn-sm btn-danger opt-delete' data-signkey ='" + val + "'>" +
                            "<span hidden='hidden'></span> 删除</button>";
                        return str;
                    }
                }
            ]
        });
        $("#add").on("click", function () {
            $("#editModal").modal("show");
            $("#id").val("");
            $("#channelForm")[0].reset();
        });
        $("#table").on("click", ".opt-delete", function () {
            var signkey = $(this).data('signkey');
            var param = {
                signKey: signkey
            }
            if (param) {
                if (!confirm("删除后将无法找回, 确定要删除吗?")) {
                    return;
                }
                $.post("/admin/AppSecret/del", param, function (data) {
                    if (data.code == 200) {
                        $("#tipMsg").text("删除成功");
                    } else {
                        $("#tipMsg").text(data.message);
                    }
                    $("#").modal('show');
                    TableHelper.doRefresh("#table");
                })
            }
        });


        $("#save").on("click", function () {
            $("#save").attr("disabled", true);
            if (!$("#channelForm").validationEngine('validate')) {
                return;
            }
            var param = {
                os: $("#os").val(),
                appVersion: $("#appVersion").val(),
                timeStamp: (new Date()).valueOf().toString(),
                createTime: (new Date()).format("yyyy-MM-dd HH:mm:ss")
            }
            $.post("/admin/AppSecret/add", param, function (data) {
                if (data.code == 200) {
                    $("#tipMsg").text("保存成功");
                    $("#editModal").modal('hide');
                    TableHelper.doRefresh("#table");
                    $("#save").removeAttr("disabled");
                } else {
                    $("#tipMsg").text(data.message);
                }
                $("#tipModal").modal('show');
            })
        });

    })
</script>
