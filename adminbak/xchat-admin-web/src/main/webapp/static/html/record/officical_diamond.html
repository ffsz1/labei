<section class="content">
    <div class="box box-primary">
        <div class="box-body">
            <section class="content-header">
                <h1 id="itemTitle"></h1>
            </section>
            <section class="content">
                <div class="row">
                    <form class="form-horizontal col-sm-6" id="infoForm">
                        <div class="form-group">
                            <label for="ernos" class="col-sm-2 control-label">拉贝号:</label>
                            <div class="col-sm-10">
                                <textarea class="form-control" name="ernos" id="ernos" placeholder="拉贝号（多个拉贝号回车分隔）"
                                          style="height:170px; resize: none"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="color:red; text-align: right;">（每个用户赠送次数以及被赠送用户的钻石余额限制请查看字典管理）</div>
                        </div>
                    </form>
                    <form class="form-horizontal col-sm-6" id="goldForm">
                        <div class="form-group" style="position: relative">
                            <label for="num" class="col-sm-2 control-label">赠送数量:</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control validate[required]" name="num" id="num" value="1.00">
                            </div>
                            <span id="formatNumber" style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); color: red;">壹点零零</span>
                        </div>
                        <div class="form-group">
                            <label for="type" class="col-sm-2 control-label">赠送类型:</label>
                            <div class="col-sm-10">
                                <select class="form-control" name="type" id="type" data-btn-class="btn-warning">
                                    <option value="77">流水发放</option>
                                    <option value="78">运营使用</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="remark" class="col-sm-2 control-label">备注:</label>
                            <div class="col-sm-10">
                                <textarea class="form-control" name="remark" id="remark" placeholder="备注"
                                          style="resize: none"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label"></label>
                            <div class="col-sm-10">
                                <button type="button" class="btn btn-primary" id="btnScan">
                                    <i class="glyphicon glyphicon-th-list"></i> 查看用户
                                </button>
                                <button type="button" class="btn btn-success" id="btnGive">
                                    <i class="glyphicon glyphicon-ok-sign"></i> 确认赠送
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </section>
        </div>
    </div>
    <div class="box box-primary">
        <div class="box-body">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="width: 25%; text-align: center;">头像</th>
                        <th style="width: 25%; text-align: center;">拉贝号</th>
                        <th style="width: 25%; text-align: center;">昵称</th>
                        <th style="width: 25%; text-align: center;">钻石</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</section>
<!-- .content -->
<script>
    let isEdit = false;
    $(function () {
        $("#goldForm").validationEngine();
        $('#btnScan').click(function () {
            if (!$('#ernos').val()) {
                $("#tipMsg").text("请输入拉贝号");
                $("#tipModal").modal('show');
                return;
            }
            $.ajax({
                type: "post",
                url: "/admin/diamond/userInfo.action",
                data: {"erbanNos": $("#ernos").val()},
                dataType: "json",
                success: function (json) {
                    if (json.code == 200) {
                        let str = '';
                        for (let i = 0; i < json.data.length; i++) {
                            const bean = json.data[i];
                            str += "<tr>\n" +
                                        "<th style=\"width: 100px; text-align: center; vertical-align: middle;\"><img src='" + bean.avatar + "' width='50'/></th>\n" +
                                        "<th style='width: 200px; text-align: center; vertical-align: middle;'>" + bean.erbanNo + "</th>\n" +
                                        "<th style='width: 300px; text-align: center; vertical-align: middle;'>" + bean.nick + "</th>\n" +
                                        "<th style='text-align: center; vertical-align: middle;'>" + bean.diamondNum + "</th>\n" +
                                    "</tr>";
                        }
                        $('#tbody').html(str);
                    }
                }
            })
        });
        $("#btnGive").click(function () {
            isEdit = true;
            const ernos = $("#ernos").val();
            const type = $('#type').val();
            const num = parseFloat($('#num').val().replace(/,/g, ''));
            const remark = $('#remark').val();
            if (!$('#ernos').val()) {
                $("#tipMsg").text("请输入拉贝号");
                $("#tipModal").modal('show');
                return;
            }

            $.ajax({
                type: "post",
                url: "/admin/diamond/give.action",
                data: {
                    'ernos': ernos,
                    'type': type,
                    'num': num,
                    'remark': remark
                },
                dataType: "json",
                success: function (json) {
                    if (json.code == 200) {
                        $("#tipMsg").text("赠送钻石成功");
                        $("#tipModal").modal('show');
                        $('#btnScan').click();
                    } else {
                        $("#tipMsg").text("赠送钻石出错, errorCode: " + json.message);
                        $("#tipModal").modal('show');
                    }
                },
                error: function (json) {
                    $("#tipMsg").text("赠送钻石出错, 网络出错");
                    $("#tipModal").modal('show');
                }
            });
        });
        // 监听数字输入输出中文数字
        $("#num").bind('input propertychange', function() {
            $("#num").val($('#num').val().replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3'));
            $('#formatNumber').text(numberToChinese(parseFloat($('#num').val())));
        });
        $("#num").blur(function() {
            if ($('#num').val().indexOf(".") > 0) {
                const front = toThousands($("#num").val().substr(0, $('#num').val().indexOf(".")).replace(/,/g, ''));
                const back = $("#num").val().substr($('#num').val().indexOf("."));
                $("#num").val(front + back);
            } else {
                const front = toThousands($("#num").val().replace(/,/g, ''));
                $("#num").val(front);
            }
        });
        // 阿拉伯数字转中文数字
        function numberToChinese(num) {
            if (!/^\d*(\.\d*)?$/.test(num)) {
                console.log("Number is wrong!");
                return "Number is wrong!";
            }

            const AA = new Array("零", "一", "二", "三", "四", "五", "六", "七", "八", "九");
            const BB = new Array("", "十", "百", "千", "万", "亿", "点", "");

            let a = ("" + num).replace(/(^0*)/g, "").split("."), k = 0, re = "";

            for (let i = a[0].length - 1; i >= 0; i--) {
                switch (k) {
                    case 0:
                        re = BB[7] + re;
                        break;
                    case 4:
                        if (!new RegExp("0{4}\\d{" + (a[0].length - i - 1) + "}$").test(a[0])) {
                            re = BB[4] + re;
                        }
                        break;
                    case 8:
                        re = BB[5] + re;
                        BB[7] = BB[5];
                        k = 0;
                        break;
                }

                if (k % 4 == 2 && a[0].charAt(i + 2) != 0 && a[0].charAt(i + 1) == 0) {
                    re = AA[0] + re;
                }

                if (a[0].charAt(i) != 0) {
                    re = AA[a[0].charAt(i)] + BB[k % 4] + re;
                }
                k++;
            }

            if (a.length > 1) {
                re += BB[6];
                for (let i = 0; i < a[1].length; i++) {
                    re += AA[a[1].charAt(i)];
                }
            }
            return re;
        };
        function toThousands(num) {
            var num = (num || 0).toString(), re = /\d{3}$/, result = '';
            while ( re.test(num) ) {
                result = RegExp.lastMatch + result;
                if (num !== RegExp.lastMatch) {
                    result = ',' + result;
                    num = RegExp.leftContext;
                } else {
                    num = '';
                    break;
                }
            }

            if (num) {
                result = num + result;
            }

            return result;
        };
    });
</script>
