<style>
    .bar1, .bar2 {
        margin-bottom: 10px;
    }

    label.col-sm-1 {
        padding: 0;
        line-height: 30px;
        text-align: right;
        /*padding-right: 4px;*/
    }

    label.col-sm-1 {
        padding: 0;
        line-height: 30px;
        text-align: right;
        /*padding-right: 4px;*/
    }

    input, select {
        margin-left: 8px;
        margin-right: 8px;
    }

    #btnSearch {
        margin-left: 36px;
    }

    .record {
        margin-top: 10px;
    }

    .record .title {
        font-size: 16px;
    }

    #waKaKa {
        display: none;
    }

    .content .form-group {
        margin-right: 2rem;
    }

    .content .form-group label {
        margin-right: 1rem;
    }

    .left {
        margin-left: 8px;
    }

    .top {
        margin-top: 10px;
    }

    .under {
        margin-bottom: 10px;
    }
</style>
<section class="content">
    <div class="box box-primary">
        <div class="box-body">
            <section class="content-header">
                <h1 id="itemTitle"></h1>
            </section>
            <section class="content">
                <div id="table"></div>
                <div id="toolbar">
                    <form class="form-inline">
                        <div class="form-group">
                            <label for="type" class="control-label">消息类型:</label>
                            <select name="msgType" id="type" class="form-control">
                                <option value="">请选择</option>
                                <option value="0">文本</option>
                                <option value="1">图片</option>
                                <option value="100">图文</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="erbanNum" class="control-label">拉贝号:</label>
                            <input type="text" class="form-control validate[required]" name="erbanNo" id="erbanNum">
                        </div>
                        <a href="javascript:;" id="btnSearch" class="btn btn-primary">
                            <i class="glyphicon glyphicon-search"></i> 查询
                        </a>
                        <a href="javascript:;" id="add" class="btn btn-warning">
                            <i class="glyphicon glyphicon-plus"></i> 增加
                        </a>
                    </form>
                </div>
            </section>
        </div>
    </div>
</section>
<div class="modal fade" id="addSendMessage" tabindex="-1" role="dialog" aria-labelledby="modalLabel2">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">x</span></button>
                <h4 class="modal-title" id="addModalLabel">新增消息</h4>
            </div>
            <div class="modal-body">
                <form id="addMsgForm" class="form-horizontal">
                    <div class="form-group">
                        <label for="receiver" class="col-sm-3 control-label">接收者：</label>
                        <div class="col-sm-8">
                            <select name="receivers" id="receiver" class="col-sm-3 form-control">
                                <option value=1>所有用户</option>
                                <option value=0>指定用户</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="msgType" class="col-sm-3 control-label">消息类型：</label>
                        <div class="col-sm-8">
                            <select name="msgTypeList" id="msgType" class="col-sm-3 form-control">
                                <option value="0">文本</option>
                                <!-- <option value="1">图片</option> -->
                                <option value="100">图文</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="skip" class="col-sm-3 control-label">跳转链接:</label>
                        <div class="col-sm-3">
                            <select name="skip" id="skip" class="form-control">
                                <option value="1">跳App页面</option>
                                <option value="2">跳聊天室</option>
                                <option value="3">跳H5页面</option>
                            </select>
                        </div>
                        <div class="col-sm-5">
                            <div class="input-group">
                                <div class="input-group-addon">http://</div>
                                <input type="text" class="form-control validate[required]" name="skipUri"
                                       id="skipUrlContent">
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="mmm">
                        <label for="aimErbanNo" class="col-sm-3 control-label">指定拉贝号：</label>
                        <div class="col-sm-8">
                            <input class="form-control validate[required]" name="aimErbanNo" id="aimErbanNo"
                                   placeholder="请输入指定拉贝号, 多个拉贝号用逗号隔开">
                        </div>
                    </div>
                    <div class="form-group" id="nnn">
                        <label for="words" class="col-sm-3 control-label">文本：</label>
                        <div class="col-sm-8">
                            <input class="form-control validate[required]" name="words" id="words">
                        </div>
                    </div>
                    <div class="form-group" id="ppp">
                        <label for="pic" class="col-sm-3 control-label">图片：</label>
                        <div class="col-sm-8">
                            <img src="/static/AdminLTE/img/add.png" id="imgUrl" style="width:250px;height:90px;" alt="">
                            <input type="file" id="uploadFile" name="uploadFile"
                                   accept="image/gif,image/jpeg,image/jpg,image/png,image/svg">
                            <button class="btn btn-success" type="button" id="uploadBtn">上传</button>
                            <span class="attention">注意:图片尺寸请注意在750*250,选择图片后请点击上传按钮</span>
                            <input type="hidden" id="pic" name="pic" class="form-control validate[required]"/>
                        </div>
                    </div>
                    <div class="form-group" id="ooo">
                        <label for="wordsAndPic1" class="col-sm-3 control-label">图文：</label>
                        <div class="col-sm-8">
                            <label for="title" class="left under">标题</label>
                            <input class="form-control validate[required] validate[maxSize[20]]" name="title"
                                      id="title">
                            <label for="title" class="left top under">内容</label>
                            <input class="form-control validate[required]" name="desc" id="desc">
                            <!--背景图-->
                            <img src="/static/AdminLTE/img/add.png" id="imgUrl1" class="left top" width="150" alt="">
                            <input type="file" id="uploadFile1" name="uploadFile"
                                   accept="image/gif,image/jpeg,image/jpg,image/png,image/svg">
                            <button class="btn btn-success left top" type="button" id="uploadBtn1">上传</button>
                            <label for="title" class="left">背景图<span class="attention">尺寸小于 750*250, 选择图片后请点击上传按钮</span></label>
                            <input type="hidden" id="wordsAndPic1" name="wordsAndPic1"
                                   class="form-control validate[required]"/>
                            <!-- 点击查询跳转图片 -->
                            <img src="/static/AdminLTE/img/add.png" id="imgUrl2" class="left" width="150" alt="">
                            <input type="file" id="uploadFile2" name="uploadFile"
                                   accept="image/gif,image/jpeg,image/jpg,image/png,image/svg">
                            <button class="btn btn-success left top" type="button" id="uploadBtn2">上传</button>
                            <label for="title" class="left">链接图<span class="attention">尺寸小于 750*250, 选择图片后请点击上传按钮</span></label>
                            <input type="hidden" id="wordsAndPic2" name="wordsAndPic2"
                                   class="form-control validate[required]"/>
                        </div>
                    </div>
                    <!-- <div class="form-group">
                        <label for="msgDesc" class="col-sm-3 control-label">消息内容：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control validate[required]" name="msgDesc" id="msgDesc">
                        </div>
                    </div> -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="addSave">保存</button>
            </div>
        </div>
    </div>
</div>
<script>
    let status = 0;

    $(function () {
        $('#table').bootstrapTable('destroy');
        $('#table').bootstrapTable({
            columns: [
                {field: 'recordId', title: 'id', align: 'center', valign: 'middle', width: '0%', visible: false},
                {field: 'fromAccid', title: '发送人', align: 'center', valign: 'middle', width: 150},
                {field: 'toErbanNos', title: '指定拉贝号', align: 'center', width: 150, valign: 'middle'},
                {field: 'toAccids', title: '接收人', align: 'center', valign: 'middle', width: 150},
                {
                    field: 'toObjType', title: '指定对象', align: 'center', width: 200, valign: 'middle',
                    formatter: function (val, row, index) {
                        switch (val) {
                            case 1:
                                return '所有人';
                            case 0:
                                return '指定用户';
                        }
                    }
                },
                {
                    field: 'msgType',
                    title: '消息类型',
                    align: 'center',
                    width: 150,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        switch (val) {
                            case 0:
                                return '文本';
                            case 1:
                                return '图片';
                            case 100:
                                return '图文';
                        }
                    }
                },
                {field: 'title', title: '标题', align: 'center', width: 250, valign: 'middle'},
                {field: 'msgDesc', title: '消息内容', align: 'center', width: 250, valign: 'middle'},
                {
                    field: 'webUrl', title: '点击查看URL', align: 'center', width: 300, valign: 'middle',
                    formatter: function (val) {
                        if (val) {
                            return `<a href="${val}">${val}</a>`;
                        } else {
                            return '-';
                        }
                    }
                },
                {
                    field: 'picUrl', title: '图片', align: 'center', width: 200, valign: 'middle',
                    formatter: function (val) {
                        return "<img src='" + val + "' alt='photo' width='70'>";
                    }
                },
                {
                    field: 'skipType', title: '跳转类型', align: 'center', valign: 'middle', width: 200,
                    formatter: function (val, row, index) {
                        switch (val) {
                            case 1:
                                return '跳App页面';
                            case 2:
                                return '跳聊天室';
                            case 3:
                                return '跳H5页面';
                        }
                    }
                },
                {
                    field: 'crateTime',
                    title: '创建时间',
                    align: 'center',
                    width: 250,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        if (val) {
                            const date = new Date(val);
                            return date.format("yyyy-MM-dd HH:mm:ss");
                        } else {
                            return '-';
                        }
                    }
                },
                // {
                //     field: 'tmp',
                //     title: '操作',
                //     align: 'center',
                //     width: '20%',
                //     valign: 'middle',
                //     formatter: function (val, row, index) {
                //         const key = row.blockId;
                //         return "<button class='btn btn-sm btn-success opt-release'  data-id=" + key + ">解封</button>&nbsp;&nbsp;"+
                //                 "<button class='btn btn-sm btn-success opt-edit'  data-id=" + key + " >编辑</button>";
                //     }
                // }
            ],
            cache: false,
            striped: true,
            showRefresh: false,
            pageSize: 10,
            pagination: true,
            pageList: [10, 20, 30, 50],
            sidePagination: "server",
            queryParamsType: "undefined",
            queryParams: function queryParams(params) {
                const param = {
                    pageSize: params.pageSize,
                    pageNumber: params.pageNumber,
                    erbanNOs: $('#erbanNum').val(),
                    msgType: $('#type').val()
                };
                return param;
            },
            uniqueId: 'code',
            toolbar: '#toolbar',
            url: '/admin/msgAdmin/getMsgList.action',
            onLoadSuccess: function () {
                console.log("load success");
            },
            onLoadError: function () {
                console.log("load fail");
            }
        });
    });

    // 查询刷新
    $('#btnSearch').on('click', function () {
        TableHelper.doRefresh('#table');
    });

    // 保存
    $('#addSave').on('click', function () {
        if (status > 0) {
            $("#tipMsg").text("有消息正在发送,请稍等...");
            $("#tipModal").modal('show');
            return false;
        }

        if ($('#addMsgForm').validationEngine('validate')) {
            $.ajax({
                type: "post",
                url: "/admin/messageAdmin/saveMessage.action",
                data: {
                    erbanNos: $("#aimErbanNo").val(),
                    msgType: $("#msgType").val(),
                    toObjType: $('#receiver').val(),
                    words: $('#words').val(),
                    pic: $('#pic').val(),
                    title: $('#title').val(),
                    desc: $('#desc').val(),
                    picUrl: $('#wordsAndPic1').val(),
                    webUrl: $('#wordsAndPic2').val(),
                    skipType: $('#skip').val(),
                    skipContent: 'http://' + $('#skipUrlContent').val()
                },
                dataType: 'json',
                success: function (data) {
                    if (data.code == 200) {
                        $('#addSendMessage').modal('hide');
                        $("#tipMsg").text("保存成功");
                        $("#tipModal").modal('show');
                        TableHelper.doRefresh("#table");
                    } else {
                        $("#tipMsg").text(data.message);
                        $("#tipModal").modal('show');
                    }
                },
                beforeSend: function () {
                    $("#tipMsg").text("消息正在发送,请稍等...");
                    $("#tipModal").modal('show');
                    $("#addSave").attr("disabled", true);
                    console.log("before");
                    status++;
                },
                complete: function () {
                    status = 0;
                    $("#addSave").removeAttr("disabled");
                }
            });
        }
    });

    // 增加
    $('#add').on('click', function () {
        clear();
        $('#addMsgForm')[0].reset();
        $('#addSendMessage').modal('show');
    });

    function clear() {
        $('#imgUrl').attr('src', '/static/AdminLTE/img/add.png');
        $('#imgUrl1').attr('src', '/static/AdminLTE/img/add.png');
        $('#imgUrl2').attr('src', '/static/AdminLTE/img/add.png');
        $("#nnn").show();
        $("#mmm").hide();
        $("#ppp").hide();
        $("#ooo").hide();
    }

    $(document).ready(function () {
        $("#mmm").hide();
        $("#ppp").hide();
        $("#ooo").hide();
    });

    $('#receiver').on('change', function (e) {
        const selected = $('#receiver').val();
        if (selected == 1) {
            $("#mmm").hide();
        }

        if (selected == 0) {
            $("#mmm").show();
            e.stopPropagation();
        }
    });

    $('#msgType').click(function (e) {
        const msgType = $('#msgType').val();
        if (msgType == 0) {
            $("#nnn").show();
            $("#ppp").hide();
            $("#ooo").hide();
        }

        if (msgType == 1) {
            $("#ppp").show();
            $("#nnn").hide();
            $("#ooo").hide();

        }

        if (msgType == 100) {
            $("#ooo").show();
            $("#ppp").hide();
            $("#nnn").hide();
            e.stopPropagation();
        }
    });


    $('#uploadBtn').on('click', function () {
        $("input[name=uploadFile]").attr("name", "");
        $("#uploadFile").attr("name", "uploadFile");
        const options = {
            type: 'post',
            url: '/admin/msg/headimg.action',
            dataType: 'json',
            success: function (json) {
                if (json.path) {
                    $('#pic').val(json.path);
                    $('#imgUrl').attr("src", json.path);
                    console.log(json.path);
                } else {
                    $("#tipMsg").text(json.msg);
                    $("#tipModal").modal('show');
                }
            }
        };
        $("#addMsgForm").ajaxSubmit(options);
    });

    $('#uploadBtn1').on('click', function () {
        $("input[name=uploadFile]").attr("name", "");
        $("#uploadFile1").attr("name", "uploadFile");
        const options = {
            type: 'post',
            url: '/admin/msg/headimg.action',
            dataType: 'json',
            success: function (json) {
                if (json.path) {
                    $('#wordsAndPic1').val(json.path);
                    $('#imgUrl1').attr('src', json.path);
                } else {
                    $('#tipMsg').text(json.msg);
                    $('#tipModal').modal('show');
                }
            }
        };
        $('#addMsgForm').ajaxSubmit(options);
    });

    $('#uploadBtn2').on('click', function () {
        $("input[name=uploadFile]").attr("name", "");
        $("#uploadFile2").attr("name", "uploadFile");
        const options = {
            type: 'post',
            url: '/admin/msg/headimg.action',
            dataType: 'json',
            success: function (json) {
                if (json.path) {
                    $('#wordsAndPic2').val(json.path);
                    $('#imgUrl2').attr('src', json.path);
                } else {
                    $('#tipMsg').text(json.msg);
                    $('#tipModal').modal('show');
                }
            }
        };
        $('#addMsgForm').ajaxSubmit(options);
    });
</script>
