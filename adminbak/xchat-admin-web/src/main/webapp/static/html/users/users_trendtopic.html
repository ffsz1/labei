<style>
    .content .form-group {
        margin-right: 2rem;
    }

    .content .form-group label {
        margin-right: 1rem;
    }
</style>
<!-- Content Header (Page header) -->
<section class="content">
    <div class="box box-primary">
        <div class="box-body">
            <section class="content-header">
                <h1 id="itemTitle"></h1>
            </section>
            <!-- .content -->
            <section class="content">
                <div id="roleTable"></div>
                <div id="toolbar">
                    <form class="form-inline" role="form">
                        <div class="form-group">
                            <label>用户id:</label>
                            <input type="text" class="form-control" name="uid" id="uid" placeholder="用户id">
                        </div>
                        <div class="form-group">
                            <label>审核状态:</label>
                            <select class="form-control" name="auditStatus" id="auditStatus">
                                <option value="">请选择</option>
                                <option value="0">未审核</option>
                                <option value="1">通过</option>
                                <option value="2">不通过</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="startDate" class="control-label">起始时间：</label>
                            <input type="text" id="startDate" type="date" name="startDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="endDate" class="control-label">结束时间：</label>
                            <input type="text" id="endDate" type="date" name="endDate" class="form-control">
                        </div>
                        <a href="javascript:;" type="text" class="btn btn-primary" id="btnSearch">
                            <i class="glyphicon glyphicon-search"></i> 查询
                        </a>
                        <button type="text" class="btn btn-success" id="btnCheckSuccess">
                            <i class="glyphicon glyphicon-ok-sign"></i> 批量通过
                        </button>
                    </form>
                </div>
            </section>
        </div>
    </div>
</section>
<!--//toolbar-->
<div class="modal fade" id="tipModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">提示信息</h4>
            </div>
            <div class="modal-body" id="tipMsg"></div>
        </div>
    </div>
</div>
<!--??-->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel"
     data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">确认信息</h4>
            </div>
            <div class="modal-body" id="confirmMsg"></div>
        </div>
    </div>
</div>
<script>
    $(function () {
        $('#roleTable').bootstrapTable('destroy');
        $('#roleTable').bootstrapTable({
            columns: [
                {field: 'cid', checkbox: true},
                {field: 'id', title: 'ID', align: 'center', width: '5%', visible: true},
                {field: 'uid', title: 'UID', align: 'center', width: '5%', visible: true},
                {field: 'themeName', title: '话题', align: 'center', width: 150},
                {field: 'nick', title: '昵称', align: 'center', width: 200},
                {field: 'name', title: '内容', align: 'center', width: 200},
                {
                    field: 'permissionType',
                    title: '权限类型',
                    align: 'center',
                    width: 150,
                    valign: 'middle',
                    formatter: function (val) {
                        switch (val) {
                            case 1:
                                return "公开";
                            case 2:
                                return '好友查看';
                            case 3:
                                return '私密';
                        }
                    }
                },
                {
                    field: 'voiceUrl', title: '声音', align: 'center', width: 200, formatter: function (val) {
                        return `<audio src="${val}" controls="controls">
                                    Your browser does not support the audio element.
                                </audio>`;
                    }
                },
                {
                    field: 'pictureUrl', title: '图片', align: 'center', width: 200, formatter: function (val) {
                        val="<img src='" + val + "' width='70'>";

                        return val.replace(/,/g,"' width='70'><img src='");
                    }
                },
                {
                    field: 'state',
                    title: '审核状态',
                    align: 'center',
                    width: 150,
                    valign: 'middle',
                    formatter: function (val) {
                        switch (val) {
                            case "0":
                                return "未审核";
                            case "1":
                                return '审核通过';
                            case "2":
                                return '审核不通过';
                        }
                    }
                },
                {
                    field: 'createTime',
                    title: '提交时间',
                    align: 'center',
                    width: 200,
                    valign: 'middle',
                    formatter: function (val) {
                        if (val) {
                            const date = new Date(val);
                            return date.format("yyyy-MM-dd hh:mm");
                        } else {
                            return '-';
                        }
                    }
                },
                {
                    field: 'uid',
                    title: '操作',
                    align: 'center',
                    width: 250,
                    formatter: function (val, row) {
                        let content = '';
                        if (row.state == '0') {
                            content += '&nbsp;&nbsp;<button class="btn btn-success opt-checkSuccess" data-id=' + row.id +
                                '><i class="glyphicon glyphicon-ok-sign"></i> 审核通过</button>';
                            content += '&nbsp;&nbsp;<button class="btn btn-danger opt-checkFailure" data-id=' + row.id +
                                '><i class="glyphicon glyphicon-remove-sign"></i> 审核不通过</button>';
                        }
                        if (row.state == "1") {
                            content += '&nbsp;&nbsp;<button class="btn btn-danger opt-checkFailure" data-id=' + row.id +
                                '><i class="glyphicon glyphicon-remove-sign"></i> 审核不通过</button>';
                        }
                        if (row.state == "2") {
                            content += '&nbsp;&nbsp;<button class="btn btn-success opt-checkSuccess" data-id=' + row.id +
                                '><i class="glyphicon glyphicon-ok-sign"></i> 审核通过</button>';
                        }
                        return content;
                    }
                }
            ],
            cache: false,
            striped: true,
            showRefresh: false,
            pageSize: 10,
            pagination: true,
            pageList: [10, 20, 30, 50],
            search: false,
            sidePagination: "server", //表示服务端请求
            //设置为undefined可以获取pageNumber，pageSize，searchText，sortName，sortOrder
            //设置为limit可以获取limit, offset, search, sort, order
            queryParamsType: "undefined",
            queryParams: function queryParams(params) {   //设置查询参数
                var param = {
                    pageNumber: params.pageNumber,
                    pageSize: params.pageSize,
                    searchText: params.searchText,
                    uid: $("#uid").val(),
                    state: $("#auditStatus").val(),
                    startDate: $("#startDate").val(),
                    endDate: $("#endDate").val()
                };
                return param;
            },
            uniqueId: 'cid',
            toolbar: '#toolbar',
            url: '/admin/user/trendtopic/getall.action',
            onLoadSuccess: function () {  //加载成功时执行
                console.log("load success");
            },
            onLoadError: function () {  //加载失败时执行
                console.log("load fail");
            }
        });
        /*初始化*/
        $('#startDate').datetimepicker({
            language: "zh-CN",
            format: 'yyyy-mm-dd hh:ii:ss',
            autoclose: true
        });
        $('#endDate').datetimepicker({
            language: "zh-CN",
            format: 'yyyy-mm-dd hh:ii:ss',
            autoclose: true
        });
        $("#roleTable").on("click", '.opt-checkSuccess', function () {
            const id = $(this).attr("data-id");
            if (id == 'undefined' || !id) {
                return;
            }
            $.ajax({
                type: 'post',
                url: "/admin/user/trendtopic/checkSuccess.action",
                data: {'ids': id},
                dataType: "json",
                success: function (json) {
                    if (json.code == 200) {
                        $("#tipMsg").text("审核成功");
                        $("#tipModal").modal('show');
                        TableHelper.doRefresh("#roleTable");
                    } else {
                        $("#tipMsg").text("审核失败");
                        $("#tipModal").modal('show');
                    }
                }
            });
        });
        $("#roleTable").on("click", '.opt-checkFailure', function () {
            const id = $(this).attr("data-id");
            if (id == 'undefined' || !id) {
                return;
            }
            if (confirm("你确认要审核不通过该记录吗?")) {
                $.ajax({
                    type: 'post',
                    url: "/admin/user/trendtopic/checkFailure.action",
                    data: {'id': id},
                    dataType: "json",
                    success: function (json) {
                        if (json.code == 200) {
                            $("#tipMsg").text("审核不通过成功");
                            $("#tipModal").modal('show');
                            TableHelper.doRefresh("#roleTable");
                        } else {
                            $("#tipMsg").text("审核不通过失败");
                            $("#tipModal").modal('show');
                        }
                    }
                });
            }
        });
        /*查询刷新*/
        $('#btnSearch').on('click', function () {
            TableHelper.doRefresh('#roleTable');
        });
        $("#btnCheckSuccess").on("click", function () {
            const selected = $('#roleTable').bootstrapTable('getSelections');
            var ids = "";
            for (var i = 0; i < selected.length; i++) {
                if (selected[i].cid == true && selected[i].state == "0") {
                    ids += selected[i].id + ",";
                }
            }
            if (!ids) {
                return;
            }
            ids = ids.substr(0, ids.length - 1);
            console.log(ids);
            $.ajax({
                type: 'post',
                url: "/admin/user/trendtopic/checkSuccess.action",
                data: {'ids': ids},
                dataType: "json",
                success: function (json) {
                    if (json.code == 200) {
                        $("#tipMsg").text("审核成功");
                        $("#tipModal").modal('show');
                        TableHelper.doRefresh("#roleTable");
                    } else {
                        $("#tipMsg").text("审核失败");
                        $("#tipModal").modal('show');
                    }
                }
            });
        })
    });

</script>
