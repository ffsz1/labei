<style>
    .bar1, .bar2 {
        margin-bottom: 10px;
    }

    label.col-sm-1 {
        padding: 0;
        line-height: 30px;
        text-align: right;
        /*padding-right: 4px;*/
    }

    label.col-sm-1 {
        padding: 0;
        line-height: 30px;
        text-align: right;
        /*padding-right: 4px;*/
    }

    input, select {
        margin-left: 8px;
        margin-right: 8px;
    }

    .record {
        margin-top: 10px;
    }

    .record .title {
        font-size: 16px;
    }
</style>
<section class="content">
    <div class="box box-primary">
        <div class="box-body">
            <section class="content-header">
                <h1 id="itemTitle"></h1>
            </section>
            <section class="content">
                <div id="table"></div>
                <div id="toolbar">
                    <form class="form-inline">
                        <div class="form-group">
                            <label class="control-label">禁言类型:</label>
                            <select name="type" id="type" class="btn btn-default dropdown-toggle" data-btn-class="btn-warning">
                                <option value="0">--全部--</option>
                                <option value="1">房间禁言</option>
                                <option value="2">私聊禁言</option>
                                <option value="3">广播禁言</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="erbanNum" class="control-label">拉贝号:</label>
                            <input type="text" class="form-control validate[required]" name="erbanNo" id="erbanNum">
                        </div>
                        <div class="form-group">
                            <label for="deviceId" class="control-label">设备号:</label>
                            <input type="text" class="form-control validate[required]" name="deviceId" id="deviceId">
                        </div>
                        <div class="form-group">
                            <label for="userIp" class="control-label">封禁ip:</label>
                            <input type="text" class="form-control validate[required]" name="blockIp" id="userIp">
                        </div>
                        <a href="javascript:;" id="add" class="btn btn-warning">
                            <i class="glyphicon glyphicon-plus"></i> 增加
                        </a>
                        <a href="javascript:;" id="btnSearch" class="btn btn-primary">
                            <i class="glyphicon glyphicon-search"></i> 查询
                        </a>
                    </form>
                </div>
            </section>
        </div>
    </div>
</section>
<div class="modal fade" id="addAccountBlocked" tabindex="-1" role="dialog" aria-labelledby="modalLabel2">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">x</span></button>
                <h4 class="modal-title" id="addModalLabel">新增禁言账户</h4>
            </div>
            <div class="modal-body">
                <form id="addBlockForm" class="form-horizontal">
                    <div class="form-group">
                        <label for="erbanNo" class="col-sm-3 control-label">拉贝号：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control validate[required]" name="erbanNo" id="erbanNo">
                            <input style="display: none;" type="text" class="form-control" name="blockIp" id="blockIp">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bannedDesc" class="col-sm-3 control-label">禁言原因：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control validate[required]" name="bannedDesc"
                                   id="bannedDesc">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bannedType" class="col-sm-3 control-label">封禁类型：</label>
                        <div class="col-sm-8">
                            <select name="bannedTypeList" id="bannedType" class="col-sm-4 validate[required]">
                                <option value="">请选择</option>
                                <option value="0">全部</option>
                                <option value="1">房间禁言</option>
                                <option value="2">私聊禁言</option>
                                <option value="3">广播禁言</option>
                            </select>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal" id="dateTime">
                    <div class="form-group">
                        <label for="addStartDate" class="col-sm-3 control-label">起始时间：</label>
                        <div class="col-sm-8">
                            <input type="text" id="addStartDate" type="date" name="startTime" disabled="disabled"
                                   class="form-control validate[required]">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="addEndDate" class="col-sm-3 control-label">结束时间：</label>
                        <div class="col-sm-8">
                            <input type="text" id="addEndDate" type="date" name="endTime"
                                   class="form-control validate[required]">
                        </div>
                    </div>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="addSave">禁言</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editModel" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">x</span></button>
                <h4 class="modal-title" id="modalLabel"> 修改禁言信息</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="updateBlock">
                    <input type="hidden" name="row" id="rowId"/>
                    <div class="form-group">
                        <label for="updateReason" class="col-sm-3 control-label">禁言原因:</label>
                        <div class="col-sm-8">
                            <input type="text" id="updateReason" name="updateReason" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="blockStatus1" class="col-sm-3 control-label">禁言状态:</label>
                        <div class="col-sm-8">
                            <select name="blockStatus1" id="blockStatus1" class="col-sm-4">
                                <option value="1">禁言中</option>
                                <option value="2">禁言结束</option>
                            </select>
                        </div>
                    </div>

                    <form class="form-horizontal" id="updateFormTime">
                        <div class="form-group">
                            <label for="startDate" class="col-sm-3 control-label">起始时间:</label>
                            <div class="col-sm-8">
                                <input type="text" id="startDate" name="startValidTime" disabled="disabled"
                                       class="form-control validate[required]">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="endDate" class="col-sm-3 control-label">结束时间:</label>
                            <div class="col-sm-8">
                                <input type="text" id="endDate" name="endValidTime"
                                       class="form-control validate[required]">
                            </div>
                        </div>
                    </form>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="saveUpdate">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
    /*初始化*/
    var picker3 = $('#addEndDate').datetimepicker({
        format: 'yyyy-mm-dd hh:ii',
        autoclose: true,
        startDate: new Date()
    })
    /* picker3.on('changeDate', function () {
         var date = $('#addEndDate').datetimepicker('getDate');
         picker3.datetimepicker('setEndDate',date);
     });*/

    var picker2 = $('#endDate').datetimepicker({
        format: 'yyyy-mm-dd hh:ii',
        autoclose: true,
        startDate: new Date()
    })
    /*picker2.on('changeDate', function () {
        var date = $('#endDate').datetimepicker('getDate');
        picker2.datetimepicker('setEndDate',date);
    });*/
    $(function () {//默认时间


        // 封禁IP
        $("#blockType").on("change", function () {
            // 切换显示
            var val = $(this).val();
            if (val == 3) {
                $("[for=erbanNo]").text("禁言IP：");
                $("#erbanNo").hide();
                $("#blockIp").show();
                $("#erbanNo").removeClass("validate[required]");
                $("#blockIp").addClass("validate[required]");
            } else {
                $("[for=erbanNo]").text("拉贝号：");
                $("#blockIp").hide();
                $("#erbanNo").show();
                $("#blockIp").addClass("validate[required]");
                $("#erbanNo").removeClass("validate[required]");
            }
        });
        var todayDate = new Date();
        var minute = todayDate.getMinutes() < 10 ? "0" + todayDate.getMinutes() : todayDate.getMinutes();
        var month = (todayDate.getMonth() + 1) < 10 ? "0" + (todayDate.getMonth() + 1) : (todayDate.getMonth() + 1);
        var todayDateStr = todayDate.getFullYear() + "-" + month + "-" + todayDate.getDate() + " " + todayDate.getHours() + ":" + minute;
        $("#addStartDate").val(todayDateStr);
        $("#startDate").val(todayDateStr);
    })

    $(function () {
        $('#table').bootstrapTable('destroy');
        $('#table').bootstrapTable({
            columns: [
                {field: 'id', title: 'id', align: 'center', valign: 'middle', width: '0%', visible: false},
                {field: 'erbanNo', title: '拉贝号', align: 'center', valign: 'middle', width: 150},
                {field: 'phone', title: '手机号', align: 'center', valign: 'middle', width: 200},
                {field: 'deviceId', title: '设备号', align: 'center', valign: 'middle', width: 250},
                {
                    field: 'bannedType',
                    title: '禁言类型',
                    align: 'center',
                    width: 120,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        switch (val) {
                            case "1":
                                return '房间禁言';
                            case "2":
                                return '私聊禁言';
                            case "3":
                                return '广播禁言';
                            case "0":
                                return "全部禁言";
                        }
                    }
                },
                {
                    field: 'bannedStartTime',
                    title: '禁言开始时间',
                    align: 'center',
                    width: 200,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        if (val) {
                            var date = new Date(val);
                            return date.format("yyyy-MM-dd HH:mm");
                        } else {
                            return '-';
                        }
                    }
                },
                {
                    field: 'bannedEndTime',
                    title: '禁言结束时间',
                    align: 'center',
                    width: 200,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        if (val) {
                            var date = new Date(val);
                            return date.format("yyyy-MM-dd HH:mm");
                        } else {
                            return '-';
                        }
                    }
                },
                {
                    field: 'bannedMinute',
                    title: '禁言时长（分钟）',
                    align: 'center',
                    width: 200,
                    valign: 'middle'
                },
                {
                    field: 'bannedStatus',
                    title: '禁言状态',
                    align: 'center',
                    width: 120,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        switch (val) {
                            case 1:
                                return '禁言中';
                                break;
                            case 2:
                                return '已解封';
                                break;
                        }
                    }
                },
                {field: 'bannedDesc', title: '禁言原因', align: 'center', width: 250, valign: 'middle'},
                {field: 'adminId', title: '管理员', align: 'center', width: 200, valign: 'middle'},
                {
                    field: 'createTime',
                    title: '创建时间',
                    align: 'center',
                    width: 200,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        if (val) {
                            var date = new Date(val);
                            return date.format("yyyy-MM-dd HH:mm");
                        } else {
                            return '-';
                        }
                    }
                },
                {
                    field: 'tmp',
                    title: '操作',
                    align: 'center',
                    width: 350,
                    valign: 'middle',
                    formatter: function (val, row, index) {
                        const key = row.id;
                        let content = "<button class='btn btn-success opt-edit'  data-id=" + key + " style='margin-right: 4px'><i class='glyphicon glyphicon-edit'></i> 编辑</button>";
                        if (row.bannedStatus == 1) {
                            content += "<button class='btn btn-danger opt-release'  data-id=" + key + "><i class='glyphicon glyphicon-remove'></i> 解封</button>&nbsp;&nbsp;";
                        }
                        return content;
                    }
                }
            ],
            cache: false,
            striped: true,
            showRefresh: false,
            pageSize: 10,
            pagination: true,
            pageList: [10, 20, 30, 50],
            sidePagination: "server", //表示服务端请求
            queryParamsType: "undefined",
            queryParams: function queryParams(params) {   //设置查询参数
                var param = {
                    pageSize: params.pageSize,
                    pageNum: params.pageNumber,
                    type: $('#type').val(),
                    erbanNo: $('#erbanNum').val(),
                    deviceId: $('#deviceId').val(),
                    userIp: $('#userIp').val()
                };
                return param;
            },
            uniqueId: 'code',
            toolbar: '#toolbar',
            url: '/admin/accountBanned/list.action',
            onLoadSuccess: function () {  //加载成功时执行
                console.log("load success");
            },
            onLoadError: function () {  //加载失败时执行
                console.log("load fail");
            }
        })
    })

    /*查询刷新*/
    $('#btnSearch').on('click', function () {
        TableHelper.doRefresh('#table');
    })


    /*保存*/
    $('#addSave').on('click', function () {
        if ($('#addBlockForm').validationEngine('validate') && $('#dateTime').validationEngine('validate')) {
            $.ajax({
                type: "post",
                url: "/admin/accountBanned/saveAccountBanned.action",
                data: {
                    erbanNo: $("#erbanNo").val(),
                    bannedDesc: $("#bannedDesc").val(),
                    bannedType: $("#bannedType").val(),
                    startBannedTime: $('#addStartDate').val(),
                    endBannedTime: $('#addEndDate').val()
                },
                dataType: 'json',
                success: function (data) {
                    if (data == 2) {
                        // IP 已经被封禁.
                        $("#tipMsg").text("保存失败，该IP被封禁,可编辑修改！");
                        $("#tipModal").modal('show');
                    } else if (data == 1) {
                        $('#addAccountBlocked').modal('hide');
                        $("#tipMsg").text("保存成功");
                        $("#tipModal").modal('show');
                        TableHelper.doRefresh("#table");
                    } else if (data == 0) {
                        $("#tipMsg").text("保存失败，无此拉贝号");
                        $("#tipModal").modal('show');
                    } else if (data == -1) {
                        $("#tipMsg").text("保存失败，该拉贝号已经被封禁,可编辑修改！");
                        $("#tipModal").modal('show');
                    } else {
                        $("#tipMsg").text("保存失败，错误码：" + data);
                        $("#tipModal").modal('show');
                    }
                }
            })
        }
    })

    //增加
    $('#add').on('click', function () {
        $('#addBlockForm')[0].reset();
        $('#addAccountBlocked').modal('show');

    })

    //解封
    $('#table').on('click', '.opt-release', function () {
        var key = parseInt($(this).data('id'));
        console.log(key, typeof key);
        $.ajax({
            type: 'post',
            url: '/admin/accountBanned/unBlockAccountBlocked.action',
            data: {'rowId': key},
            dataType: 'json',
            success: function (data) {
                if (data == 1) {
                    $("#tipMsg").text("解封成功");
                    $("#tipModal").modal('show');
                    TableHelper.doRefresh("#table");
                } else if (data == 2) {
                    $("#tipMsg").text("状态正常，无需解封！");
                    $("#tipModal").modal('show');
                } else {
                    $("#tipMsg").text("解封失败，错误码：" + data);
                    $("#tipModal").modal('show');
                }
            }
        })
    })

    //编辑
    $('#table').on('click', '.opt-edit', function () {
        var key = parseInt($(this).data('id'));
        // 打开编辑弹窗
        $('#addBlockForm')[0].reset();
        $("#editModel").modal('show');
        $("#rowId").val(key);
        $.ajax({
            type: 'post',
            url: '/admin/accountBanned/getUpdateAccountBlocked.action',
            data: {rowId: key},
            dataType: 'json',
            success: function (res) {
                if (res.code == 200) {
                    var accountBlock = res.data.bannedDesc;
                    var time = res.data.bannedEndTime;
                    $("#updateReason").val(accountBlock);
                    // $("#endDate").val(time);
                    $("#blockStatus1").val(res.data.bannedStatus);
                }
            }
        })
    })


    //编辑弹窗保存
    $("#saveUpdate").click(function () {
        if ($("#updateBlock").validationEngine('validate')) {
            $.ajax({
                type: 'post',
                url: '/admin/accountBanned/updateAccountBlocked.action',
                data: {
                    rowId: $("#rowId").val(),
                    bannedType: $("#blockStatus1").val(),
                    startBannedTime: $('#startDate').val(),
                    endBannedTime: $('#endDate').val(),
                    bannedDesc: $('#updateReason').val()
                },
                dataType: 'json',
                success: function (data) {
                    if (data == 1) {
                        $("#editModel").modal('hide');
                        $("#tipMsg").text("修改成功");
                        $("#tipModal").modal('show');
                        TableHelper.doRefresh("#table");
                    } else {
                        $("#tipMsg").text("修改失败，错误码：" + data);
                        $("#tipModal").modal('show');
                    }
                }
            })
        }
    })

</script>


