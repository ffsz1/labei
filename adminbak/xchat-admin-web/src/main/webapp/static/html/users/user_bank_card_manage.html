<meta http-equiv="Expires" content="0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-control" content="no-cache">
<meta http-equiv="Cache" content="no-cache">

<section class="content">
    <div class="box box-primary">
        <div class="box-body">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1 id="itemTitle"></h1>
            </section>
            <!-- .content -->
            <section class="content">
                <div id="table"></div>
                <div id="toolbar">
                    <div class="form-group">
                        <textarea name="noList" id="noList" placeholder="请输入拉贝号，多个拉贝号请用逗号隔开"></textarea>
                    </div>

                    <button id="gift-add" class="btn btn-default">
                        <i class="glyphicon glyphicon-plus"></i>增加
                    </button>

                    <button id="gift-refresh" class="btn btn-default">
                        <i class="glyphicon glyphicon-wrench"></i>查询
                    </button>
                </div>
            </section><!-- .content -->
        </div>
    </div>
</section>
<div class="modal fade" id="giftModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="modalLabel">银行卡信息</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="giftForm">
                    <input type="hidden" name="id" id="id"/>
                    <input type="hidden" name="uid" id="uid"/>
                    <div class="form-group">
                        <label for="erbanNo" class="col-sm-2 control-label">用户号码</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control validate[required]" name="erbanNo" id="erbanNo">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bankCard" class="col-sm-2 control-label">卡号</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control validate[required]" name="bankCard" id="bankCard">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bankCardName" class="col-sm-2 control-label">姓名</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control validate[required]" name="bankCardName" id="bankCardName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="openBankCode" class="col-sm-2 control-label">银行</label>
                        <div class="col-sm-10">
                            <select name="openBankCode" id="openBankCode" data-btn-class="btn-warning">
                                <option value="0100">邮政银行</option>
                                <option value="0102">工商银行</option>
                                <option value="0103">农业银行</option>
                                <option value="0104">中国银行</option>
                                <option value="0105">建设银行</option>
                                <option value="0301">交通银行</option>
                                <option value="0302">中信银行</option>
                                <option value="0303">光大银行</option>
                                <option value="0304">华夏银行</option>
                                <option value="0305">民生银行</option>
                                <option value="0306">广发银行</option>
                                <option value="0308">招商银行</option>
                                <option value="0309">兴业银行</option>
                                <option value="0310">浦发银行</option>
                                <option value="0318">平安银行</option>
                                <option value="0403">北京银行</option>
                                <option value="0408">宁波银行</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="save">保存</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="tipModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">提示信息</h4>
            </div>
            <div class="modal-body" id="tipMsg"></div>
        </div>
    </div>
</div>

<script src="../../static/js/ajaxfileupload.js"></script>
<script>
    $(function () {
        $('#table').bootstrapTable('destroy');
        $('#table').bootstrapTable({
            columns: [
                {field: 'tmp', title: 'ID', align: 'center', checkbox: true},
                {field: 'erbanNo', title: '拉贝号', align: 'center', width: '10%'},
                {field: 'nick', title: '名字', align: 'center', width: '10%'},
                {field: 'bankCard', title: '卡号', align: 'center', width: '20%'},
                {field: 'bankCardName', title: '名字', align: 'center', width: '10%'},
                {field: 'openBankCode', title: '银行', align: 'center', width: '10%', formatter:function(val,row, index){
                    if(val == "0100"){
                        return '邮政银行';
                    } else if (val == "0102") {
                        return '工商银行'
                    } else if (val == "0103") {
                        return '农业银行'
                    } else if (val == "0104") {
                        return '中国银行'
                    } else if (val == "0105") {
                        return '建设银行'
                    } else if (val == "0301") {
                        return '交通银行'
                    } else if (val == "0302") {
                        return '中信银行'
                    } else if (val == "0303") {
                        return '光大银行'
                    } else if (val == "0304") {
                        return '华夏银行'
                    } else if (val == "0305") {
                        return '民生银行'
                    } else if (val == "0306") {
                        return '广发银行'
                    } else if (val == "0308") {
                        return '招商银行'
                    } else if (val == "0309") {
                        return '兴业银行'
                    } else if (val == "0310") {
                        return '浦发银行'
                    } else if (val == "0318") {
                        return '平安银行'
                    } else if (val == "0403") {
                        return '北京银行'
                    } else if (val == "0408") {
                        return '宁波银行'
                    } else {
                        return '未知'
                    }
                }},
                {field: 'isUse', title: '默认', align: 'center', width: '5%', formatter:function(val,row, index){
                    if(val == 1){
                        return '是';
                    } else {
                        return '否'
                    }
                }},
                {field: 'id', title: '操作', align: 'center', width: '15%', formatter: function(val, row, index){
                        return '<button class="btn btn-sm btn-success opt-edit" data-id=' + val + '>' +
                                '<i class="glyphicon glyphicon-edit"></i>编辑</button>' +
                                '<button class="btn btn-sm btn-danger opt-del" data-id=' + val + '>' +
                                '<i class="glyphicon glyphicon-edit"></i>删除</button>'+
                                '<button class="btn btn-sm btn-success opt-use" data-id=' + val + '>' +
                                '<i class="glyphicon glyphicon-edit"></i>使用</button>' ;
                }}
            ],
            cache: false,
            striped: true,
            showRefresh: false,
            pageSize: 10,
            pagination: true,
            pageList: [1, 10, 20, 30, 50],
            search: false,
            sidePagination: "server", //表示服务端请求
            //设置为undefined可以获取pageNumber，pageSize，searchText，sortName，sortOrder
            //设置为limit可以获取limit, offset, search, sort, order
            queryParamsType: "undefined",
            queryParams: function queryParams(params) {   //设置查询参数
                var param = {
                    pageNumber: params.pageNumber,
                    pageSize: params.pageSize,
                    noList: $("#noList").val()
                };
                return param;
            },
            toolbar: '#toolbar',
            url: '/admin/user/bankCard/findUserBankCard.action',
            onLoadSuccess: function () {  //加载成功时执行
                console.log("load success");
            },
            onLoadError: function () {  //加载失败时执行
                console.log("load fail");
            }
        });

        $("#gift-add").click(function(){
            // 打开编辑弹窗
            $("#id").val('');
            $("#uid").val('');
            $("#erbanNo").attr('readonly', false);
            $("#giftModal").modal('show');
            $("#giftForm")[0].reset();
        });

        $("#gift-refresh").click(function(){
            TableHelper.doRefresh("#table");
        })

        $("#table").on("click", '.opt-edit', function () {
            var id = $(this).attr("data-id");
            $.ajax({
                type: "get",
                url: "/admin/user/bankCard/getOne.action",
                data: {id: id},
                dataType: "json",
                success: function (json) {
                    if(json.data){
                        $("#id").val(json.data.id);
                        $("#uid").val(json.data.uid);
                        $("#erbanNo").val(json.data.erbanNo);
                        $("#bankCard").val(json.data.bankCard);
                        $("#bankCardName").val(json.data.bankCardName);
                        $('#openBankCode').val(json.data.openBankCode);
                        $("#erbanNo").attr('readonly', true);
                        // 打开编辑弹窗
                        $("#giftModal").modal('show');
                    }else{
                        $("#tipMsg").text("获取菜单信息出错");
                        $("#tipModal").modal('show');
                    }
                }
            });
        });

        $("#table").on("click", '.opt-use', function () {
            var id = $(this).attr("data-id");
            $.ajax({
                type: "post",
                url: "/admin/user/bankCard/use.action",
                data: {id: id},
                dataType: "json",
                success: function (json) {
                    if(json.code == 200){
                        $("#tipMsg").text("使用成功");
                        $("#tipModal").modal('show');
                        TableHelper.doRefresh("#table");
                    }else{
                        $("#tipMsg").text("保存失败." + json.message);
                        $("#tipModal").modal('show');
                    }
                }
            });
        });


        $("#table").on("click", '.opt-del', function () {
            var id = $(this).attr("data-id");
            if (confirm("你确认删除该记录吗?" +
                "\r\n删除后再也不能找回，请谨慎操作！")) {
                $.ajax({
                    type: 'post',
                    url: '/admin/user/bankCard/del.action',
                    data: {"id": id},
                    dataType: 'json',
                    success: function (res) {
                        if (res.code == 200) {
                            $("#tipMsg").text("删除成功");
                            $("#tipModal").modal('show');
                            TableHelper.doRefresh("#table");
                        } else {
                            $("#tipMsg").text("删除失败，错误码：" + res.code);
                            $("#tipModal").modal('show');
                        }
                    }
                });
            }
        });


        $("#save").click(function(){
            if($("#giftForm").validationEngine('validate')){
                $.ajax({
                    type: "post",
                    url: "/admin/user/bankCard/save.action",
                    data: $('#giftForm').serialize(),
                    dataType: "json",
                    success: function (json) {
                        if(json.code == 200){
                            $("#giftModal").modal('hide');
                            $("#tipMsg").text("保存成功");
                            $("#tipModal").modal('show');
                            TableHelper.doRefresh("#table");
                        }else{
                            $("#tipMsg").text("保存失败." + json.message);
                            $("#tipModal").modal('show');
                        }
                    }
                });
            };
        });
    });

</script>
