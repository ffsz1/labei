<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.erban.main.mybatismapper.duty.DutyDailyRecordMapper">

    <resultMap id="DutyDailyRecordMap" type="com.erban.main.mybatismapper.duty.domain.DutyDailyRecord">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="uid" property="uid" jdbcType="BIGINT"/>
        <result column="duty_id" property="dutyId" jdbcType="VARCHAR"/>
        <result column="ud_status" property="udStatus" jdbcType="BIGINT"/>
        <result column="gold_amount" property="goldAmount" jdbcType="TINYINT"/>
        <result column="create_time" property="createTime" jdbcType="TINYINT"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <insert id="save" parameterType="com.erban.main.mybatismapper.duty.domain.DutyDailyRecord">
        <trim prefix="INSERT INTO `duty_daily_record` (" suffix=")" suffixOverrides=",">
            <if test="uid != null">`uid`,</if>
            <if test="dutyId != null">`duty_id`,</if>
            <if test="udStatus != null">`ud_status`,</if>
            <if test="goldAmount != null">`gold_amount`,</if>
            <if test="createTime != null">`create_time`,</if>
            <if test="updateTime != null">`update_time`,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="uid != null">#{uid},</if>
            <if test="dutyId != null">#{dutyId},</if>
            <if test="udStatus != null">#{udStatus},</if>
            <if test="goldAmount != null">#{goldAmount},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <update id="update" parameterType="com.erban.main.mybatismapper.duty.domain.DutyDailyRecord">
        <![CDATA[ UPDATE `duty_daily_record` ]]>
        <set>
            <if test="udStatus != null">`ud_status` = #{udStatus},</if>
            <if test="goldAmount != null">`gold_amount` = #{goldAmount},</if>
            <if test="updateTime != null">`update_time` = NOW(),</if>
        </set>
        <![CDATA[ WHERE id = #{id} ]]>
    </update>

    <select id="getFreshDuty" resultMap="DutyDailyRecordMap">
        <![CDATA[
        SELECT
          *
        FROM
          duty_daily_record
        WHERE
		  duty_id = #{dutyId}
		AND
		  uid = #{uid}
        ]]>
    </select>

    <select id="getDailyDuty" resultMap="DutyDailyRecordMap">
        <![CDATA[
        SELECT
          *
        FROM
          duty_daily_record
        WHERE
		  duty_id = #{dutyId}
		AND
		  uid = #{uid}
		AND
		  create_time >= DATE_FORMAT(NOW(),'%Y-%m-%d 00:00:00')
        AND
          create_time <= DATE_FORMAT(NOW(),'%Y-%m-%d 23:59:59')
        LIMIT 1
        ]]>
    </select>

    <select id="listFreshDuties" parameterType="long" resultType="com.erban.main.service.duty.dto.DutyResultDTO">
        <![CDATA[
        SELECT
          d.id AS dutyId,
          d.duty_name AS dutyName,
          d.gold_amount AS goldAmount,
          ddr.ud_status AS udStatus
        FROM
          duty d
        LEFT JOIN
          duty_daily_record ddr
        ON
          d.id = ddr.duty_id
        AND
          ddr.uid = #{uid}
        WHERE
          d.duty_status = 1
        AND
          d.duty_type = 1
        AND (
          ddr.ud_status is null OR ddr.ud_status<>3
        )
        ORDER BY d.id
        ]]>
    </select>

    <select id="listDailyDuties" parameterType="long" resultType="com.erban.main.service.duty.dto.DutyResultDTO">
        <![CDATA[
        SELECT
          d.id AS dutyId,
          d.duty_name AS dutyName,
          d.gold_amount AS goldAmount,
          ddr.ud_status AS udStatus
        FROM
          duty d
        LEFT JOIN
          duty_daily_record ddr
        ON
          d.id = ddr.duty_id
        AND
          ddr.uid = #{uid}
        AND
          ddr.create_time >= DATE_FORMAT(NOW(),'%Y-%m-%d 00:00:00')
        AND
          ddr.create_time <= DATE_FORMAT(NOW(),'%Y-%m-%d 23:59:59')
        WHERE
          d.duty_status = 1
        AND
          d.duty_type = 2
        ORDER BY d.id
        ]]>
    </select>

    <select id="listDailyTime" parameterType="long" resultType="com.erban.main.service.duty.dto.DutyResultDTO">
        <![CDATA[
        SELECT
          d.id AS dutyId,
          d.duty_name AS dutyName,
          d.gold_amount AS goldAmount,
          ifnull(ddr.ud_status, 1) AS udStatus
        FROM
          duty d
        LEFT JOIN
          duty_daily_record ddr
        ON
          d.id = ddr.duty_id
        AND
          ddr.uid = #{uid}
        AND
          ddr.create_time >= DATE_FORMAT(NOW(),'%Y-%m-%d 00:00:00')
        AND
          ddr.create_time <= DATE_FORMAT(NOW(),'%Y-%m-%d 23:59:59')
        WHERE
          d.duty_status = 1
        AND
          d.duty_type = 3
        ORDER BY d.id
        ]]>
    </select>




</mapper>
