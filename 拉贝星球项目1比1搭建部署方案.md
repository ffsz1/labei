# æ‹‰è´æ˜Ÿçƒé¡¹ç›® 1:1 æ­å»ºéƒ¨ç½²æ–¹æ¡ˆ

> **é¡¹ç›®åç§°ï¼š** æ‹‰è´æ˜Ÿçƒï¼ˆè¯­éŸ³ç¤¾äº¤/ç›´æ’­å¹³å°ï¼‰  
> **æŠ€æœ¯æ¶æ„ï¼š** Spring Boot + Spring MVC + Node.js + Vue.js  
> **ç”Ÿæˆæ—¶é—´ï¼š** 2025-11-10  
> **é€‚ç”¨åœºæ™¯ï¼š** ä»é›¶å¼€å§‹å®Œæ•´æ­å»ºé¡¹ç›®ç¯å¢ƒ

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
2. [åŸºç¡€ç¯å¢ƒå®‰è£…](#åŸºç¡€ç¯å¢ƒå®‰è£…)
3. [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
4. [åç«¯æœåŠ¡æ­å»º](#åç«¯æœåŠ¡æ­å»º)
5. [IMæœåŠ¡å™¨æ­å»º](#imæœåŠ¡å™¨æ­å»º)
6. [H5å‰ç«¯éƒ¨ç½²](#h5å‰ç«¯éƒ¨ç½²)
7. [é…ç½®æ–‡ä»¶è¯¦è§£](#é…ç½®æ–‡ä»¶è¯¦è§£)
8. [å¯åŠ¨é¡ºåº](#å¯åŠ¨é¡ºåº)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- **CPUï¼š** 4æ ¸åŠä»¥ä¸Š
- **å†…å­˜ï¼š** 8GBåŠä»¥ä¸Šï¼ˆæ¨è16GBï¼‰
- **ç¡¬ç›˜ï¼š** 50GBå¯ç”¨ç©ºé—´

### è½¯ä»¶ç¯å¢ƒ

| è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|------|---------|------|
| **JDK** | 1.8+ | Javaåç«¯è¿è¡Œç¯å¢ƒ |
| **Maven** | 3.5+ | Javaé¡¹ç›®æ„å»ºå·¥å…· |
| **Node.js** | 8.x - 12.x | IMæœåŠ¡å™¨è¿è¡Œç¯å¢ƒ |
| **npm** | 6.x+ | Node.jsåŒ…ç®¡ç†å™¨ |
| **MySQL** | 5.7+ | ä¸»æ•°æ®åº“ |
| **Redis** | 3.2+ | ç¼“å­˜æ•°æ®åº“ |
| **MongoDB** | 4.0+ | IMæ¶ˆæ¯å­˜å‚¨ |
| **ActiveMQ** | 5.15+ | æ¶ˆæ¯é˜Ÿåˆ— |
| **Nginx** | 1.16+ | WebæœåŠ¡å™¨/åå‘ä»£ç† |
| **PM2** | æœ€æ–°ç‰ˆ | Node.jsè¿›ç¨‹ç®¡ç† |

---

## ğŸš€ åŸºç¡€ç¯å¢ƒå®‰è£…

### 1. å®‰è£… JDK 1.8

#### Windows
```bash
# ä¸‹è½½ JDK 1.8
# https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html

# é…ç½®ç¯å¢ƒå˜é‡
JAVA_HOME=C:\Program Files\Java\jdk1.8.0_xxx
Path=%JAVA_HOME%\bin

# éªŒè¯å®‰è£…
java -version
javac -version
```

#### Linux
```bash
# CentOS/RHEL
sudo yum install java-1.8.0-openjdk-devel

# Ubuntu/Debian
sudo apt-get install openjdk-8-jdk

# éªŒè¯å®‰è£…
java -version
```

### 2. å®‰è£… Maven

#### Windows
```bash
# ä¸‹è½½ Maven
# https://maven.apache.org/download.cgi

# è§£å‹åˆ° C:\Program Files\Apache\maven

# é…ç½®ç¯å¢ƒå˜é‡
MAVEN_HOME=C:\Program Files\Apache\maven
Path=%MAVEN_HOME%\bin

# éªŒè¯å®‰è£…
mvn -version
```

#### Linux
```bash
# ä¸‹è½½å¹¶è§£å‹
wget https://dlcdn.apache.org/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz
tar -xzf apache-maven-3.8.6-bin.tar.gz
sudo mv apache-maven-3.8.6 /opt/maven

# é…ç½®ç¯å¢ƒå˜é‡
echo 'export MAVEN_HOME=/opt/maven' >> ~/.bashrc
echo 'export PATH=$MAVEN_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# éªŒè¯å®‰è£…
mvn -version
```

### 3. å®‰è£… Node.js å’Œ npm

#### Windows
```bash
# ä¸‹è½½ Node.js 12.x LTS
# https://nodejs.org/dist/v12.22.12/node-v12.22.12-x64.msi

# å®‰è£…åéªŒè¯
node -v
npm -v

# å®‰è£… PM2
npm install -g pm2
```

#### Linux
```bash
# ä½¿ç”¨ nvm å®‰è£…ï¼ˆæ¨èï¼‰
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 12
nvm use 12

# éªŒè¯å®‰è£…
node -v
npm -v

# å®‰è£… PM2
npm install -g pm2
```

### 4. å®‰è£… MySQL 5.7

#### Windows
```bash
# ä¸‹è½½ MySQL 5.7
# https://dev.mysql.com/downloads/mysql/5.7.html

# å®‰è£…åé…ç½®
# è®¾ç½® root å¯†ç 
# å¯åŠ¨ MySQL æœåŠ¡
```

#### Linux (CentOS 7)
```bash
# æ·»åŠ  MySQL ä»“åº“
wget https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm
sudo rpm -ivh mysql57-community-release-el7-11.noarch.rpm

# å®‰è£… MySQL
sudo yum install mysql-server

# å¯åŠ¨ MySQL
sudo systemctl start mysqld
sudo systemctl enable mysqld

# è·å–ä¸´æ—¶å¯†ç 
sudo grep 'temporary password' /var/log/mysqld.log

# ä¿®æ”¹ root å¯†ç 
mysql -uroot -p
ALTER USER 'root'@'localhost' IDENTIFIED BY 'ä½ çš„å¯†ç ';
FLUSH PRIVILEGES;
```

### 5. å®‰è£… Redis

#### Windows
```bash
# ä¸‹è½½ Redis for Windows
# https://github.com/microsoftarchive/redis/releases

# è§£å‹åè¿è¡Œ
redis-server.exe redis.windows.conf

# è®¾ç½®å¯†ç ï¼ˆä¿®æ”¹ redis.windows.confï¼‰
requirepass ä½ çš„å¯†ç 
```

#### Linux
```bash
# CentOS/RHEL
sudo yum install redis

# Ubuntu/Debian
sudo apt-get install redis-server

# å¯åŠ¨ Redis
sudo systemctl start redis
sudo systemctl enable redis

# è®¾ç½®å¯†ç 
sudo vi /etc/redis/redis.conf
# æ‰¾åˆ° # requirepass foobared
# ä¿®æ”¹ä¸º requirepass ä½ çš„å¯†ç 

# é‡å¯ Redis
sudo systemctl restart redis
```

### 6. å®‰è£… MongoDB

#### Windows
```bash
# ä¸‹è½½ MongoDB 4.0
# https://www.mongodb.com/try/download/community

# å®‰è£…åå¯åŠ¨æœåŠ¡
net start MongoDB
```

#### Linux
```bash
# CentOS 7
# åˆ›å»º yum æºæ–‡ä»¶
sudo vi /etc/yum.repos.d/mongodb-org-4.0.repo

# æ·»åŠ ä»¥ä¸‹å†…å®¹
[mongodb-org-4.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc

# å®‰è£… MongoDB
sudo yum install -y mongodb-org

# å¯åŠ¨ MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod

# åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
mongo
use artqiyi
db.createUser({
  user: "artqiyi",
  pwd: "kjhDh38273erdfEd",
  roles: [{role: "readWrite", db: "artqiyi"}]
})
```

### 7. å®‰è£… ActiveMQ

#### Windows/Linux
```bash
# ä¸‹è½½ ActiveMQ 5.15.x
wget https://archive.apache.org/dist/activemq/5.15.16/apache-activemq-5.15.16-bin.tar.gz

# è§£å‹
tar -xzf apache-activemq-5.15.16-bin.tar.gz
sudo mv apache-activemq-5.15.16 /opt/activemq

# å¯åŠ¨ ActiveMQ
cd /opt/activemq
./bin/activemq start

# è®¿é—®ç®¡ç†ç•Œé¢
# http://localhost:8161/admin
# é»˜è®¤ç”¨æˆ·å/å¯†ç : admin/admin
```

### 8. å®‰è£… Nginx

#### Windows
```bash
# ä¸‹è½½ Nginx
# http://nginx.org/en/download.html

# è§£å‹åˆ° C:\nginx
# å¯åŠ¨
cd C:\nginx
start nginx
```

#### Linux
```bash
# CentOS/RHEL
sudo yum install nginx

# Ubuntu/Debian
sudo apt-get install nginx

# å¯åŠ¨ Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

---

## ğŸ’¾ æ•°æ®åº“é…ç½®

### 1. å¯¼å…¥ MySQL æ•°æ®åº“

```bash
# åˆ›å»ºæ•°æ®åº“
mysql -uroot -p
CREATE DATABASE labei DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE yingtao DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;

# å¯¼å…¥æ•°æ®åº“è„šæœ¬
mysql -uroot -p labei < C:/Users/ä¼˜é…ªæ—¶å…‰/Desktop/labei/labei.sql

# éªŒè¯å¯¼å…¥
mysql -uroot -p
USE labei;
SHOW TABLES;
```

### 2. é…ç½® MySQL ç”¨æˆ·æƒé™

```sql
-- åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER 'labei'@'%' IDENTIFIED BY 'ä½ çš„å¯†ç ';
GRANT ALL PRIVILEGES ON labei.* TO 'labei'@'%';
GRANT ALL PRIVILEGES ON yingtao.* TO 'labei'@'%';
FLUSH PRIVILEGES;

-- å…è®¸è¿œç¨‹è¿æ¥ï¼ˆå¦‚éœ€è¦ï¼‰
-- ä¿®æ”¹ /etc/my.cnf æˆ– my.ini
-- bind-address = 0.0.0.0
```

### 3. Redis æ•°æ®åº“é…ç½®

```bash
# è¿æ¥ Redis
redis-cli -a ä½ çš„å¯†ç 

# æŸ¥çœ‹æ•°æ®åº“
INFO keyspace

# Redis ä½¿ç”¨çš„æ•°æ®åº“ç¼–å·
# DB 0: ä¸šåŠ¡é€»è¾‘æ•°æ®
# DB 1: æ¡†æ¶ç¼“å­˜æ•°æ®
# DB 2: IMé›†ç¾¤ç®¡ç†æ•°æ®
```

### 4. MongoDB é…ç½®

```bash
# è¿æ¥ MongoDB
mongo -u artqiyi -p kjhDh38273erdfEd --authenticationDatabase artqiyi

# æŸ¥çœ‹é›†åˆ
use artqiyi
show collections
```

---

## ğŸ—ï¸ åç«¯æœåŠ¡æ­å»º

### æ¨¡å—1: adminbak (æ—§ç‰ˆç®¡ç†åå°)

#### 1.1 é…ç½®æ–‡ä»¶ä¿®æ”¹

**æ–‡ä»¶ä½ç½®ï¼š** `adminbak/xchat-admin-web/src/main/resources/application-web.properties`

```properties
# MySQL é…ç½®
erban.main.jdbc.dbname=labei
write.erban.main.jdbc.host=127.0.0.1
write.erban.main.jdbc.port=3306
write.erban.main.jdbc.username=root
write.erban.main.jdbc.password=ä½ çš„MySQLå¯†ç 

# Redis é…ç½®
redis.default.write.host=127.0.0.1
redis.default.write.port=6379
redis.default.read.host=127.0.0.1
redis.default.read.port=6379
redis.default.password=ä½ çš„Rediså¯†ç 

# ActiveMQ é…ç½®
activemq.brokerURL=127.0.0.1
activemq.port=61616
```

**æ–‡ä»¶ä½ç½®ï¼š** `adminbak/xchat-admin-web/src/main/resources/config.properties`

```properties
# ç¯ä¿¡é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
API_PROTOCAL=https
API_HOST=a1.easemob.com
API_ORG=1104170215115585
API_APP=xchat
APP_CLIENT_ID=YXA6t-aqYPNmEea3FmVvm1rnzA
APP_CLIENT_SECRET=YXA6tue7a1x7xLZKIGksrXxs6b3ClQ4

# IMæœåŠ¡å™¨åœ°å€
imUrl=http://127.0.0.1:81

# ä¸ƒç‰›äº‘é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
qiniu.access_url=
qiniu.access_key=
qiniu.secret_key=
qiniu.bucket=

# å£°ç½‘é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
agora.app_iD=
agora.app_certificate=
```

#### 1.2 ç¼–è¯‘æ‰“åŒ…

```bash
cd C:/Users/ä¼˜é…ªæ—¶å…‰/Desktop/labei/adminbak

# æ¸…ç†å¹¶ç¼–è¯‘
mvn clean package -DskipTests

# æ‰“åŒ…æˆåŠŸåï¼ŒWARæ–‡ä»¶ä½ç½®ï¼š
# adminbak/xchat-admin-web/target/ROOT.war
# adminbak/xchat-web/target/ROOT.war
# adminbak/xchat-oauth2-web/target/ROOT.war
```

#### 1.3 éƒ¨ç½²åˆ° Tomcat

```bash
# ä¸‹è½½ Tomcat 8.5
# https://tomcat.apache.org/download-80.cgi

# éƒ¨ç½² WAR æ–‡ä»¶
# å°† ROOT.war å¤åˆ¶åˆ° Tomcat çš„ webapps ç›®å½•

# å¯åŠ¨ Tomcat
# Windows: bin/startup.bat
# Linux: bin/startup.sh

# è®¿é—®åœ°å€
# ç®¡ç†åå°: http://localhost:8080
```

### æ¨¡å—2: apiservice (æ–°ç‰ˆAPIæœåŠ¡)

#### 2.1 é…ç½®æ–‡ä»¶ä¿®æ”¹

**æ–‡ä»¶ä½ç½®ï¼š** `apiservice/pom.xml`

æ‰¾åˆ° `<profile>` éƒ¨åˆ†ï¼Œä¿®æ”¹å¯¹åº”ç¯å¢ƒçš„é…ç½®ï¼š

```xml
<!-- local ç¯å¢ƒé…ç½® -->
<profile>
    <id>local</id>
    <activation>
        <activeByDefault>true</activeByDefault>
    </activation>
    <properties>
        <!-- MySQL ä¸»åº“é…ç½® -->
        <spring.datasource.master.url><![CDATA[jdbc:mysql://127.0.0.1:3306/labei?useUnicode=true&characterEncoding=utf-8&allowMultiQueries=true]]></spring.datasource.master.url>
        <spring.datasource.master.username><![CDATA[root]]></spring.datasource.master.username>
        <spring.datasource.master.password><![CDATA[ä½ çš„MySQLå¯†ç ]]></spring.datasource.master.password>
        
        <!-- MySQL ä»åº“é…ç½® -->
        <spring.datasource.slave.url><![CDATA[jdbc:mysql://127.0.0.1:3306/labei?useUnicode=true&characterEncoding=utf-8&allowMultiQueries=true]]></spring.datasource.slave.url>
        <spring.datasource.slave.username><![CDATA[root]]></spring.datasource.slave.username>
        <spring.datasource.slave.password><![CDATA[ä½ çš„MySQLå¯†ç ]]></spring.datasource.slave.password>
        
        <!-- Redis é…ç½® -->
        <spring.redis.host><![CDATA[127.0.0.1]]></spring.redis.host>
        <spring.redis.port><![CDATA[6379]]></spring.redis.port>
        <spring.redis.password><![CDATA[ä½ çš„Rediså¯†ç ]]></spring.redis.password>
        
        <!-- ActiveMQ é…ç½® -->
        <spring.activemq.brokerurl><![CDATA[tcp://127.0.0.1:61616]]></spring.activemq.brokerurl>
        
        <!-- IMæœåŠ¡å™¨åœ°å€ -->
        <external.im.host>http://127.0.0.1:81</external.im.host>
        
        <!-- æœåŠ¡å™¨åŸŸå -->
        <common.system.serverDomain>http://ä½ çš„åŸŸå</common.system.serverDomain>
    </properties>
</profile>
```

**æ–‡ä»¶ä½ç½®ï¼š** `apiservice/xchat-manager/src/main/resources/xchat.manager.yml`

```yaml
external:
  # çŸ­ä¿¡é…ç½®
  caih:
    clientId: ä½ çš„å®¢æˆ·ç«¯ID
    password: ä½ çš„å¯†ç 
    smsSendUrl: http://api.mms.caih.com/sms-partner/access/
    smsTemplate: ã€æ‹‰è´æ˜Ÿçƒã€‘æ‚¨çš„éªŒè¯ç ï¼š%sï¼Œ2åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œè¯·å°½å¿«å®ŒæˆéªŒè¯ã€‚
  
  # å£°ç½‘é…ç½®
  agora:
    appId: ä½ çš„AppID
    appCertificate: ä½ çš„è¯ä¹¦
  
  # ç½‘æ˜“äº‘ä¿¡é…ç½®
  netease:
    appKey: ä½ çš„AppKey
    appSecret: ä½ çš„AppSecret
  
  # Ping++ æ”¯ä»˜é…ç½®
  pingxx:
    appId: ${external.pingxx.appId}
    apiKey: ${external.pingxx.apiKey}
  
  # ä¸ƒç‰›äº‘é…ç½®
  qiniu:
    accessUrl: ä½ çš„è®¿é—®åœ°å€
    accessKey: ä½ çš„AccessKey
    secretKey: ä½ çš„SecretKey
    bucket: ä½ çš„Bucketåç§°
  
  # å¾®ä¿¡é…ç½®
  weixin:
    appid: ä½ çš„AppID
    secret: ä½ çš„Secret
    mchid: ä½ çš„å•†æˆ·ID
    paykey: ä½ çš„æ”¯ä»˜å¯†é’¥
  
  # æå…‰æ¨é€é…ç½®
  jpush:
    appKey: ä½ çš„AppKey
    secret: ä½ çš„Secret
  
  # IMæœåŠ¡å™¨é…ç½®
  im:
    host: ${external.im.host}
```

#### 2.2 ç¼–è¯‘æ‰“åŒ…

```bash
cd C:/Users/ä¼˜é…ªæ—¶å…‰/Desktop/labei/apiservice

# ä½¿ç”¨ local ç¯å¢ƒç¼–è¯‘
mvn clean package -Plocal -DskipTests

# ä½¿ç”¨ test ç¯å¢ƒç¼–è¯‘
mvn clean package -Ptest -DskipTests

# æ‰“åŒ…æˆåŠŸåï¼ŒJARæ–‡ä»¶ä½ç½®ï¼š
# apiservice/xchat-web-api/target/appservice.jar
# apiservice/xchat-web-admin/target/appservice-admin.jar
# apiservice/xchat-web-oauth2/target/appservice-oauth2.jar
# apiservice/xchat-web-record/target/appservice-record.jar
# apiservice/xchat-web-task/target/appservice-task.jar
```

#### 2.3 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ API æœåŠ¡ï¼ˆä¸»æœåŠ¡ï¼‰
java -jar apiservice/xchat-web-api/target/appservice.jar --server.port=8080

# å¯åŠ¨ç®¡ç†åå°æœåŠ¡
java -jar apiservice/xchat-web-admin/target/appservice-admin.jar --server.port=8081

# å¯åŠ¨ OAuth2 æœåŠ¡
java -jar apiservice/xchat-web-oauth2/target/appservice-oauth2.jar --server.port=8082

# å¯åŠ¨è®°å½•ç»Ÿè®¡æœåŠ¡
java -jar apiservice/xchat-web-record/target/appservice-record.jar --server.port=8083

# å¯åŠ¨å®šæ—¶ä»»åŠ¡æœåŠ¡
java -jar apiservice/xchat-web-task/target/appservice-task.jar --server.port=8084
```

#### 2.4 åå°è¿è¡Œï¼ˆLinuxï¼‰

```bash
# åˆ›å»ºå¯åŠ¨è„šæœ¬
vi start-api.sh

#!/bin/bash
nohup java -jar apiservice/xchat-web-api/target/appservice.jar --server.port=8080 > logs/api.log 2>&1 &
nohup java -jar apiservice/xchat-web-admin/target/appservice-admin.jar --server.port=8081 > logs/admin.log 2>&1 &
nohup java -jar apiservice/xchat-web-oauth2/target/appservice-oauth2.jar --server.port=8082 > logs/oauth2.log 2>&1 &
nohup java -jar apiservice/xchat-web-record/target/appservice-record.jar --server.port=8083 > logs/record.log 2>&1 &
nohup java -jar apiservice/xchat-web-task/target/appservice-task.jar --server.port=8084 > logs/task.log 2>&1 &

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x start-api.sh

# å¯åŠ¨æœåŠ¡
./start-api.sh
```

---

## ğŸ“¡ IMæœåŠ¡å™¨æ­å»º

### 1. é…ç½®æ–‡ä»¶ä¿®æ”¹

**æ–‡ä»¶ä½ç½®ï¼š** `imsvr/config/development.js`

```javascript
module.exports = {
    // Java æœåŠ¡å™¨åœ°å€
    java_host: "127.0.0.1",
    java_port: 8080,
    
    // å³æ„é…ç½®
    zego_host: "liveroom197844898-api.zego.im",
    
    // ç«¯å£é…ç½®ï¼ˆé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ å…¥ï¼‰
    port: parseInt(process.argv[2]),
    http_port: parseInt(process.argv[2]) + 1,
    websocket_port: parseInt(process.argv[2]),
    socketio_port: parseInt(process.argv[2]) + 2,
    cronsvr_port: parseInt(process.argv[2]) + 3,
    
    // å›¾ç‰‡æœåŠ¡å™¨é…ç½®
    image_ip: "ä½ çš„åŸŸå",
    image_port: 443,
    image_upload_path: "/uploadfiles/",
    image_static: "/public/",
    
    // MySQL é…ç½®
    mysqlServers: [
        {
            host: '127.0.0.1',
            port: 3306,
            user: 'root',
            password: 'ä½ çš„MySQLå¯†ç '
        }
    ],
    mysqlDatabase: 'labei',
    mysqlMaxConnections: 10,
    mysqlQueryTimeout: 5000,
    
    // Redis é…ç½®
    redis: {
        host: '127.0.0.1',
        port: 6379,
        db: 0,           // ä¸šåŠ¡é€»è¾‘ä½¿ç”¨çš„åº“
        db_cache: 1,     // æ¡†æ¶dbç¼“å­˜ä½¿ç”¨
        db_sub: 2,       // imé›†ç¾¤ç®¡ç†ç”¨
        options: {
            auth_pass: 'ä½ çš„Rediså¯†ç '
        }
    },
    
    // Java Redis é…ç½®
    javaredis: {
        host: '127.0.0.1',
        port: 6379,
        db: 0,
        options: {
            auth_pass: 'ä½ çš„Rediså¯†ç '
        }
    },
    
    // MongoDB é…ç½®
    mongo: {
        uri: 'mongodb://127.0.0.1:27017/artqiyi',
        options: {
            db: { native_parser: true },
            auto_reconnect: 1,
            server: { poolSize: 4 },
            user: 'artqiyi',
            pass: 'kjhDh38273erdfEd'
        }
    }
};
```

### 2. å®‰è£…ä¾èµ–

```bash
cd C:/Users/ä¼˜é…ªæ—¶å…‰/Desktop/labei/imsvr

# å®‰è£… Node.js ä¾èµ–
npm install

# å¦‚æœé‡åˆ°ä¾èµ–é—®é¢˜ï¼Œä½¿ç”¨
npm install --legacy-peer-deps
```

### 3. å¯åŠ¨ IM æœåŠ¡å™¨

#### Windows å¯åŠ¨

```bash
cd C:/Users/ä¼˜é…ªæ—¶å…‰/Desktop/labei/imsvr

# å¯åŠ¨ IM æœåŠ¡ï¼ˆç«¯å£ 3000ï¼‰
pm2 start im-svr.js --name "im-svr-3000" -- 3000

# å¯åŠ¨ HTTP æœåŠ¡ï¼ˆç«¯å£ 3001ï¼‰
pm2 start http-svr.js --name "http-svr-3001" -- 3000

# å¯åŠ¨å®šæ—¶ä»»åŠ¡æœåŠ¡ï¼ˆç«¯å£ 3003ï¼‰
pm2 start cron-svr.js --name "cron-svr-3003" -- 3000

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
pm2 list

# æŸ¥çœ‹æ—¥å¿—
pm2 logs
```

#### Linux å¯åŠ¨

```bash
cd /path/to/labei/imsvr

# ä½¿ç”¨å¯åŠ¨è„šæœ¬
chmod +x start.sh
./start.sh 3000

# æˆ–ä½¿ç”¨ PM2 é…ç½®æ–‡ä»¶
pm2 start pm2.json --env development

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
pm2 list
pm2 monit
```

### 4. IM æœåŠ¡å™¨ç«¯å£è¯´æ˜

| ç«¯å£ | æœåŠ¡ | è¯´æ˜ |
|------|------|------|
| 3000 | WebSocket | IMå®æ—¶é€šä¿¡ç«¯å£ |
| 3001 | HTTP API | HTTPæ¥å£æœåŠ¡ |
| 3002 | Socket.io | Socket.ioæœåŠ¡ |
| 3003 | Cron | å®šæ—¶ä»»åŠ¡æœåŠ¡ |

---

## ğŸŒ H5å‰ç«¯éƒ¨ç½²

### 1. é…ç½® API åœ°å€

**æ–‡ä»¶ä½ç½®ï¼š** `h5/front/lib/api.js`

```javascript
// ä¿®æ”¹ API åœ°å€
const formalUrl = "http://ä½ çš„åŸŸå:8080"
const formalUrl1 = "http://ä½ çš„åŸŸå:8080"
const baseUrl = 'http://ä½ çš„åŸŸå:8080'
```

### 2. éƒ¨ç½²åˆ° Nginx

#### 2.1 å¤åˆ¶æ–‡ä»¶åˆ° Nginx ç›®å½•

```bash
# Windows
xcopy /E /I C:\Users\ä¼˜é…ªæ—¶å…‰\Desktop\labei\h5 C:\nginx\html\h5

# Linux
cp -r /path/to/labei/h5 /usr/share/nginx/html/
```

#### 2.2 é…ç½® Nginx

**æ–‡ä»¶ä½ç½®ï¼š** `/etc/nginx/nginx.conf` æˆ– `C:\nginx\conf\nginx.conf`

```nginx
server {
    listen 80;
    server_name ä½ çš„åŸŸå;
    
    # H5 é¡µé¢
    location / {
        root html/h5;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API ä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # IM æœåŠ¡ä»£ç†
    location /im/ {
        proxy_pass http://127.0.0.1:3001/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
    
    # WebSocket ä»£ç†
    location /socket.io/ {
        proxy_pass http://127.0.0.1:3002/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

#### 2.3 é‡å¯ Nginx

```bash
# Windows
cd C:\nginx
nginx -s reload

# Linux
sudo nginx -t
sudo systemctl reload nginx
```

---

## ğŸ“ é…ç½®æ–‡ä»¶è¯¦è§£

### å…³é”®é…ç½®é¡¹è¯´æ˜

#### 1. æ•°æ®åº“é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `erban.main.jdbc.dbname` | æ•°æ®åº“åç§° | `labei` |
| `write.erban.main.jdbc.host` | MySQLä¸»æœºåœ°å€ | `127.0.0.1` |
| `write.erban.main.jdbc.port` | MySQLç«¯å£ | `3306` |
| `write.erban.main.jdbc.username` | MySQLç”¨æˆ·å | `root` |
| `write.erban.main.jdbc.password` | MySQLå¯†ç  | `ä½ çš„å¯†ç ` |

#### 2. Redis é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `redis.default.write.host` | Redisä¸»æœºåœ°å€ | `127.0.0.1` |
| `redis.default.write.port` | Redisç«¯å£ | `6379` |
| `redis.default.password` | Rediså¯†ç  | `ä½ çš„å¯†ç ` |

#### 3. ActiveMQ é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `activemq.brokerURL` | ActiveMQåœ°å€ | `127.0.0.1` |
| `activemq.port` | ActiveMQç«¯å£ | `61616` |

#### 4. IM æœåŠ¡å™¨é…ç½®

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `java_host` | JavaæœåŠ¡å™¨åœ°å€ | `127.0.0.1` |
| `java_port` | JavaæœåŠ¡å™¨ç«¯å£ | `8080` |
| `mysqlDatabase` | æ•°æ®åº“åç§° | `labei` |

---

## ğŸ”„ å¯åŠ¨é¡ºåº

### æ­£ç¡®çš„å¯åŠ¨é¡ºåº

```
1. MySQL æ•°æ®åº“
   â†“
2. Redis ç¼“å­˜
   â†“
3. MongoDB æ•°æ®åº“
   â†“
4. ActiveMQ æ¶ˆæ¯é˜Ÿåˆ—
   â†“
5. apiservice åç«¯æœåŠ¡ï¼ˆæˆ– adminbakï¼‰
   â†“
6. imsvr IMæœåŠ¡å™¨
   â†“
7. Nginx WebæœåŠ¡å™¨
```

### å¯åŠ¨è„šæœ¬ç¤ºä¾‹

#### Windows å¯åŠ¨è„šæœ¬ (start-all.bat)

```batch
@echo off
echo æ­£åœ¨å¯åŠ¨æ‹‰è´æ˜Ÿçƒé¡¹ç›®...

echo [1/7] æ£€æŸ¥ MySQL...
sc query MySQL | find "RUNNING" > nul
if errorlevel 1 (
    echo MySQL æœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨...
    net start MySQL
)

echo [2/7] æ£€æŸ¥ Redis...
tasklist | find "redis-server.exe" > nul
if errorlevel 1 (
    echo Redis æœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨...
    start /b redis-server.exe redis.windows.conf
)

echo [3/7] æ£€æŸ¥ MongoDB...
sc query MongoDB | find "RUNNING" > nul
if errorlevel 1 (
    echo MongoDB æœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨...
    net start MongoDB
)

echo [4/7] æ£€æŸ¥ ActiveMQ...
tasklist | find "java.exe" | find "activemq" > nul
if errorlevel 1 (
    echo ActiveMQ æœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨...
    start /b C:\activemq\bin\activemq.bat start
)

echo [5/7] å¯åŠ¨ API æœåŠ¡...
cd C:\Users\ä¼˜é…ªæ—¶å…‰\Desktop\labei\apiservice\xchat-web-api\target
start /b java -jar appservice.jar --server.port=8080

echo [6/7] å¯åŠ¨ IM æœåŠ¡å™¨...
cd C:\Users\ä¼˜é…ªæ—¶å…‰\Desktop\labei\imsvr
pm2 start im-svr.js --name "im-svr" -- 3000
pm2 start http-svr.js --name "http-svr" -- 3000

echo [7/7] å¯åŠ¨ Nginx...
cd C:\nginx
start nginx

echo.
echo ========================================
echo æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆï¼
echo ========================================
echo APIæœåŠ¡: http://localhost:8080
echo IMæœåŠ¡: http://localhost:3001
echo H5é¡µé¢: http://localhost
echo ========================================
pause
```

#### Linux å¯åŠ¨è„šæœ¬ (start-all.sh)

```bash
#!/bin/bash

echo "æ­£åœ¨å¯åŠ¨æ‹‰è´æ˜Ÿçƒé¡¹ç›®..."

# 1. å¯åŠ¨ MySQL
echo "[1/7] æ£€æŸ¥ MySQL..."
systemctl is-active --quiet mysqld || systemctl start mysqld
sleep 2

# 2. å¯åŠ¨ Redis
echo "[2/7] æ£€æŸ¥ Redis..."
systemctl is-active --quiet redis || systemctl start redis
sleep 2

# 3. å¯åŠ¨ MongoDB
echo "[3/7] æ£€æŸ¥ MongoDB..."
systemctl is-active --quiet mongod || systemctl start mongod
sleep 2

# 4. å¯åŠ¨ ActiveMQ
echo "[4/7] æ£€æŸ¥ ActiveMQ..."
if ! pgrep -f activemq > /dev/null; then
    /opt/activemq/bin/activemq start
    sleep 5
fi

# 5. å¯åŠ¨ API æœåŠ¡
echo "[5/7] å¯åŠ¨ API æœåŠ¡..."
cd /path/to/labei/apiservice/xchat-web-api/target
nohup java -jar appservice.jar --server.port=8080 > /var/log/labei/api.log 2>&1 &
sleep 5

# 6. å¯åŠ¨ IM æœåŠ¡å™¨
echo "[6/7] å¯åŠ¨ IM æœåŠ¡å™¨..."
cd /path/to/labei/imsvr
pm2 start im-svr.js --name "im-svr" -- 3000
pm2 start http-svr.js --name "http-svr" -- 3000
sleep 3

# 7. å¯åŠ¨ Nginx
echo "[7/7] æ£€æŸ¥ Nginx..."
systemctl is-active --quiet nginx || systemctl start nginx

echo ""
echo "========================================"
echo "æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆï¼"
echo "========================================"
echo "APIæœåŠ¡: http://localhost:8080"
echo "IMæœåŠ¡: http://localhost:3001"
echo "H5é¡µé¢: http://localhost"
echo "========================================"
```

---

## â“ å¸¸è§é—®é¢˜

### 1. Maven ç¼–è¯‘å¤±è´¥

**é—®é¢˜ï¼š** ä¾èµ–ä¸‹è½½å¤±è´¥æˆ–ç¼–è¯‘é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ¸…ç† Maven ç¼“å­˜
mvn clean

# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿ
# ä¿®æ”¹ ~/.m2/settings.xml
<mirror>
    <id>aliyun</id>
    <mirrorOf>central</mirrorOf>
    <name>Aliyun Maven</name>
    <url>https://maven.aliyun.com/repository/public</url>
</mirror>

# è·³è¿‡æµ‹è¯•é‡æ–°ç¼–è¯‘
mvn clean package -DskipTests
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

**é—®é¢˜ï¼š** `Communications link failure`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ MySQL æ˜¯å¦å¯åŠ¨
# Windows
sc query MySQL

# Linux
systemctl status mysqld

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -an | grep 3306

# æ£€æŸ¥é˜²ç«å¢™
# Linux
sudo firewall-cmd --add-port=3306/tcp --permanent
sudo firewall-cmd --reload
```

### 3. Redis è¿æ¥å¤±è´¥

**é—®é¢˜ï¼š** `NOAUTH Authentication required`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ Redis å¯†ç é…ç½®
redis-cli
AUTH ä½ çš„å¯†ç 
PING

# ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 
# ç¡®ä¿æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„ Redis å¯†ç ä¸€è‡´
```

### 4. IM æœåŠ¡å™¨å¯åŠ¨å¤±è´¥

**é—®é¢˜ï¼š** `Cannot find module` æˆ–ç«¯å£å ç”¨

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# é‡æ–°å®‰è£…ä¾èµ–
cd imsvr
rm -rf node_modules
npm install

# æ£€æŸ¥ç«¯å£å ç”¨
# Windows
netstat -ano | findstr :3000

# Linux
lsof -i :3000

# æ€æ­»å ç”¨è¿›ç¨‹
# Windows
taskkill /PID è¿›ç¨‹ID /F

# Linux
kill -9 è¿›ç¨‹ID
```

### 5. Nginx 403 Forbidden

**é—®é¢˜ï¼š** è®¿é—® H5 é¡µé¢å‡ºç° 403 é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
# Linux
chmod -R 755 /usr/share/nginx/html/h5

# æ£€æŸ¥ SELinux
# Linux
setenforce 0

# æ£€æŸ¥ Nginx é…ç½®
nginx -t
```

### 6. è·¨åŸŸé—®é¢˜

**é—®é¢˜ï¼š** å‰ç«¯è°ƒç”¨ API å‡ºç° CORS é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š
```nginx
location /api/ {
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
    add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
    
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    proxy_pass http://127.0.0.1:8080/;
}
```

### 7. å†…å­˜ä¸è¶³

**é—®é¢˜ï¼š** Java æœåŠ¡å¯åŠ¨åå†…å­˜æº¢å‡º

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# è°ƒæ•´ JVM å‚æ•°
java -Xms512m -Xmx2048m -jar appservice.jar

# æˆ–åœ¨å¯åŠ¨è„šæœ¬ä¸­è®¾ç½®
export JAVA_OPTS="-Xms512m -Xmx2048m -XX:PermSize=256m -XX:MaxPermSize=512m"
```

---

## ğŸ“Š æœåŠ¡éªŒè¯

### éªŒè¯æ¸…å•

| æœåŠ¡ | éªŒè¯æ–¹æ³• | é¢„æœŸç»“æœ |
|------|---------|---------|
| **MySQL** | `mysql -uroot -p` | æˆåŠŸç™»å½• |
| **Redis** | `redis-cli -a å¯†ç  PING` | è¿”å› `PONG` |
| **MongoDB** | `mongo -u artqiyi -p` | æˆåŠŸç™»å½• |
| **ActiveMQ** | è®¿é—® `http://localhost:8161/admin` | æ˜¾ç¤ºç®¡ç†ç•Œé¢ |
| **APIæœåŠ¡** | è®¿é—® `http://localhost:8080/swagger-ui.html` | æ˜¾ç¤º Swagger æ–‡æ¡£ |
| **IMæœåŠ¡** | è®¿é—® `http://localhost:3001` | è¿”å› JSON å“åº” |
| **H5é¡µé¢** | è®¿é—® `http://localhost` | æ˜¾ç¤ºé¦–é¡µ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **é…ç½®åŸŸåå’ŒSSLè¯ä¹¦**
   - ç”³è¯·åŸŸå
   - é…ç½® DNS è§£æ
   - ç”³è¯· SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰
   - é…ç½® Nginx HTTPS

2. **æ€§èƒ½ä¼˜åŒ–**
   - é…ç½® Redis æŒä¹…åŒ–
   - é…ç½® MySQL ä¸»ä»å¤åˆ¶
   - é…ç½® Nginx ç¼“å­˜
   - é…ç½® CDN åŠ é€Ÿ

3. **ç›‘æ§å’Œæ—¥å¿—**
   - é…ç½®æ—¥å¿—æ”¶é›†ï¼ˆELKï¼‰
   - é…ç½®æ€§èƒ½ç›‘æ§ï¼ˆPrometheus + Grafanaï¼‰
   - é…ç½®å‘Šè­¦ï¼ˆé’‰é’‰/é‚®ä»¶ï¼‰

4. **å¤‡ä»½ç­–ç•¥**
   - é…ç½®æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½
   - é…ç½®æ–‡ä»¶å¤‡ä»½
   - é…ç½®ç¾éš¾æ¢å¤æ–¹æ¡ˆ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ‰€æœ‰æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
2. é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®ä¿®æ”¹
3. ç«¯å£æ˜¯å¦è¢«å ç”¨
4. é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ç›¸åº”ç«¯å£
5. æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯

**æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š**
- APIæœåŠ¡: `apiservice/xchat-web-api/logs/`
- IMæœåŠ¡: `imsvr/logs/` æˆ– `~/.pm2/logs/`
- Nginx: `/var/log/nginx/` æˆ– `C:\nginx\logs\`

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-11-10
**é€‚ç”¨ç‰ˆæœ¬ï¼š** æ‹‰è´æ˜Ÿçƒå®Œæ•´æºç 

---

## ğŸ“¦ é™„å½•Aï¼šå®Œæ•´é…ç½®æ–‡ä»¶æ¸…å•

### adminbak æ¨¡å—é…ç½®æ–‡ä»¶

```
adminbak/
â”œâ”€â”€ xchat-admin-web/src/main/resources/
â”‚   â”œâ”€â”€ application-web.properties      # æ•°æ®åº“ã€Redisã€ActiveMQé…ç½®
â”‚   â”œâ”€â”€ config.properties               # ç¯ä¿¡ã€ä¸ƒç‰›ã€å£°ç½‘ç­‰ç¬¬ä¸‰æ–¹é…ç½®
â”‚   â”œâ”€â”€ application-context-mybatis.xml # MyBatisé…ç½®
â”‚   â”œâ”€â”€ application-context-redis.xml   # Redisè¿æ¥æ± é…ç½®
â”‚   â””â”€â”€ application-context-activemq.xml # ActiveMQé…ç½®
â”œâ”€â”€ xchat-web/src/main/resources/
â”‚   â”œâ”€â”€ application-web.properties
â”‚   â””â”€â”€ config.properties
â””â”€â”€ xchat-oauth2-web/src/main/resources/
    â”œâ”€â”€ application-oauth2-web.properties
    â””â”€â”€ config.properties
```

### apiservice æ¨¡å—é…ç½®æ–‡ä»¶

```
apiservice/
â”œâ”€â”€ pom.xml                             # Mavenå¤šç¯å¢ƒé…ç½®ï¼ˆé‡è¦ï¼ï¼‰
â”œâ”€â”€ xchat-web-api/src/main/resources/
â”‚   â””â”€â”€ application.yml                 # Spring Bootä¸»é…ç½®
â”œâ”€â”€ xchat-web-admin/src/main/resources/
â”‚   â””â”€â”€ application.yml
â”œâ”€â”€ xchat-web-oauth2/src/main/resources/
â”‚   â””â”€â”€ application.yml
â”œâ”€â”€ xchat-web-record/src/main/resources/
â”‚   â””â”€â”€ application.yml
â”œâ”€â”€ xchat-web-task/src/main/resources/
â”‚   â””â”€â”€ application.yml
â””â”€â”€ xchat-manager/src/main/resources/
    â””â”€â”€ xchat.manager.yml               # å¤–éƒ¨æœåŠ¡é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
```

### imsvr æ¨¡å—é…ç½®æ–‡ä»¶

```
imsvr/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ index.js                        # é…ç½®å…¥å£
â”‚   â”œâ”€â”€ development.js                  # å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆé‡è¦ï¼ï¼‰
â”‚   â”œâ”€â”€ production.js                   # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ basic.js                        # åŸºç¡€é…ç½®
â”‚   â””â”€â”€ debug.js                        # è°ƒè¯•é…ç½®
â”œâ”€â”€ pm2.json                            # PM2è¿›ç¨‹ç®¡ç†é…ç½®
â””â”€â”€ package.json                        # Node.jsä¾èµ–é…ç½®
```

---

## ğŸ“¦ é™„å½•Bï¼šæ•°æ®åº“è¡¨ç»“æ„è¯´æ˜

### æ ¸å¿ƒæ•°æ®è¡¨

| è¡¨å | è¯´æ˜ | é‡è¦å­—æ®µ |
|------|------|---------|
| **users** | ç”¨æˆ·è¡¨ | uid, erban_no, nick, avatar, gender, phone |
| **account** | è´¦å·è¡¨ | uid, phone, password, sign_time |
| **room** | æˆ¿é—´è¡¨ | uid, title, is_permit_room, can_show |
| **gift** | ç¤¼ç‰©è¡¨ | gift_id, gift_name, gold_price, gift_type |
| **gift_send_record** | ç¤¼ç‰©å‘é€è®°å½• | uid, room_uid, gift_id, gift_num, create_time |
| **charge_order** | å……å€¼è®¢å• | uid, order_no, amount, status, pay_type |
| **withdraw_order** | æç°è®¢å• | uid, amount, status, account_type |
| **room_mic_list** | éº¦ä½åˆ—è¡¨ | room_id, mic_index, uid, status |
| **family** | å®¶æ—è¡¨ | family_id, family_name, owner_uid |
| **guild** | å…¬ä¼šè¡¨ | guild_id, guild_name, owner_uid |
| **rank_wealth** | è´¢å¯Œæ¦œ | uid, total_gold, rank_type, rank_date |
| **rank_charm** | é­…åŠ›æ¦œ | uid, total_charm, rank_type, rank_date |
| **banner** | Banneré…ç½® | banner_id, title, image_url, link_url |
| **activity** | æ´»åŠ¨è¡¨ | activity_id, title, start_time, end_time |

### Redis Key è¯´æ˜

#### adminbak/apiservice ä½¿ç”¨çš„ Redis Key

```
# ç”¨æˆ·ç›¸å…³
yingtao_uid_ticket                      # ç”¨æˆ·Tokenæ˜ å°„
yingtao_user_info_{uid}                 # ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
yingtao_user_level_{uid}                # ç”¨æˆ·ç­‰çº§ç¼“å­˜

# æˆ¿é—´ç›¸å…³
yingtao_room_room_id                    # æˆ¿é—´IDé›†åˆ
yingtao_room_mic_list_{room_id}         # æˆ¿é—´éº¦ä½åˆ—è¡¨
yingtao_room_{room_id}                  # æˆ¿é—´ä¿¡æ¯ç¼“å­˜

# æ’è¡Œæ¦œç›¸å…³
yingtao_rank_wealth_day_{date}          # è´¢å¯Œæ—¥æ¦œ
yingtao_rank_wealth_week_{date}         # è´¢å¯Œå‘¨æ¦œ
yingtao_rank_charm_day_{date}           # é­…åŠ›æ—¥æ¦œ
yingtao_rank_charm_week_{date}          # é­…åŠ›å‘¨æ¦œ

# ç¤¼ç‰©ç›¸å…³
yingtao_gift_list                       # ç¤¼ç‰©åˆ—è¡¨ç¼“å­˜
yingtao_gift_{gift_id}                  # ç¤¼ç‰©è¯¦æƒ…ç¼“å­˜
```

#### imsvr ä½¿ç”¨çš„ Redis Key

```
# IMè¿æ¥ç®¡ç†
imxinpi_uniid_svr_map_{uid}             # ç”¨æˆ·æ‰€åœ¨æœåŠ¡å™¨æ˜ å°„
imxinpi_token_uid_map_{token}           # Tokenåˆ°UIDæ˜ å°„
imxinpi_user_map_socket_key_{uid}       # ç”¨æˆ·Socketè¿æ¥åˆ—è¡¨

# æˆ¿é—´ç®¡ç†
imxinpi_room_info_{room_id}             # æˆ¿é—´ä¿¡æ¯
imxinpi_roomid_map_uid_key_{room_id}    # æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
imxinpi_uid_map_roomid_key_{uid}        # ç”¨æˆ·æˆ¿é—´åˆ—è¡¨
imxinpi_room_blacklist_{room_id}        # æˆ¿é—´é»‘åå•
imxinpi_room_mute_{room_id}             # æˆ¿é—´ç¦è¨€åˆ—è¡¨
imxinpi_room_manager_{room_id}          # æˆ¿é—´ç®¡ç†å‘˜åˆ—è¡¨

# éº¦åºç®¡ç†
imxinpi_room_map_queue_mem_key_{room_id} # æˆ¿é—´éº¦åºæˆå‘˜ä¿¡æ¯

# å…¬èŠå¤§å…
imxinpi_public_roomid_map_uid_zset_key_{room_id}  # å…¬èŠå¤§å…ç”¨æˆ·åˆ—è¡¨
```

---

## ğŸ“¦ é™„å½•Cï¼šAPIæ¥å£æ–‡æ¡£

### apiservice ä¸»è¦æ¥å£

#### ç”¨æˆ·ç›¸å…³æ¥å£

```
POST   /user/register              # ç”¨æˆ·æ³¨å†Œ
POST   /user/login                 # ç”¨æˆ·ç™»å½•
GET    /user/info                  # è·å–ç”¨æˆ·ä¿¡æ¯
POST   /user/update                # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
POST   /user/uploadAvatar          # ä¸Šä¼ å¤´åƒ
GET    /user/level                 # è·å–ç”¨æˆ·ç­‰çº§
```

#### æˆ¿é—´ç›¸å…³æ¥å£

```
GET    /room/list                  # æˆ¿é—´åˆ—è¡¨
GET    /room/info/{roomId}         # æˆ¿é—´è¯¦æƒ…
POST   /room/create                # åˆ›å»ºæˆ¿é—´
POST   /room/update                # æ›´æ–°æˆ¿é—´ä¿¡æ¯
POST   /room/close                 # å…³é—­æˆ¿é—´
GET    /room/recommend             # æ¨èæˆ¿é—´
```

#### ç¤¼ç‰©ç›¸å…³æ¥å£

```
GET    /gift/list                  # ç¤¼ç‰©åˆ—è¡¨
POST   /gift/send                  # å‘é€ç¤¼ç‰©
GET    /gift/wall                  # ç¤¼ç‰©å¢™
POST   /gift/draw                  # ç¤¼ç‰©æŠ½å¥–
```

#### å……å€¼ç›¸å…³æ¥å£

```
GET    /charge/products            # å……å€¼äº§å“åˆ—è¡¨
POST   /charge/create              # åˆ›å»ºå……å€¼è®¢å•
POST   /charge/callback            # å……å€¼å›è°ƒ
GET    /charge/records             # å……å€¼è®°å½•
```

#### æ’è¡Œæ¦œæ¥å£

```
GET    /rank/wealth/day            # è´¢å¯Œæ—¥æ¦œ
GET    /rank/wealth/week           # è´¢å¯Œå‘¨æ¦œ
GET    /rank/charm/day             # é­…åŠ›æ—¥æ¦œ
GET    /rank/charm/week            # é­…åŠ›å‘¨æ¦œ
GET    /rank/room                  # æˆ¿é—´æ¦œ
```

### imsvr ä¸»è¦æ¥å£

#### WebSocket äº‹ä»¶

```
# å®¢æˆ·ç«¯å‘é€
login                               # ç™»å½•è®¤è¯
enterChatRoom                       # è¿›å…¥èŠå¤©å®¤
leaveChatRoom                       # ç¦»å¼€èŠå¤©å®¤
sendMessage                         # å‘é€æ¶ˆæ¯
heartbeat                           # å¿ƒè·³

# æœåŠ¡å™¨æ¨é€
onMessage                           # æ¥æ”¶æ¶ˆæ¯
onUserEnter                         # ç”¨æˆ·è¿›å…¥
onUserLeave                         # ç”¨æˆ·ç¦»å¼€
onGiftSend                          # ç¤¼ç‰©å‘é€
onKickOut                           # è¢«è¸¢å‡ºæˆ¿é—´
```

#### HTTP æ¥å£

```
POST   /room/create                # åˆ›å»ºæˆ¿é—´ï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰
POST   /room/close                 # å…³é—­æˆ¿é—´
POST   /message/push               # æ¨é€æ¶ˆæ¯
GET    /room/members               # è·å–æˆ¿é—´æˆå‘˜
POST   /room/kickout               # è¸¢å‡ºç”¨æˆ·
```

---

## ğŸ“¦ é™„å½•Dï¼šç¬¬ä¸‰æ–¹æœåŠ¡é…ç½®

### 1. ç¯ä¿¡ï¼ˆå³æ—¶é€šè®¯ï¼‰

```properties
# config.properties
API_PROTOCAL=https
API_HOST=a1.easemob.com
API_ORG=ä½ çš„ç»„ç»‡ID
API_APP=ä½ çš„åº”ç”¨å
APP_CLIENT_ID=ä½ çš„ClientID
APP_CLIENT_SECRET=ä½ çš„ClientSecret
```

**è·å–æ–¹å¼ï¼š**
1. æ³¨å†Œç¯ä¿¡è´¦å·ï¼šhttps://console.easemob.com/
2. åˆ›å»ºåº”ç”¨
3. è·å– AppKeyã€ClientIDã€ClientSecret

### 2. ä¸ƒç‰›äº‘ï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰

```properties
# config.properties
qiniu.access_url=https://ä½ çš„åŸŸå
qiniu.access_key=ä½ çš„AccessKey
qiniu.secret_key=ä½ çš„SecretKey
qiniu.bucket=ä½ çš„Bucketåç§°
```

**è·å–æ–¹å¼ï¼š**
1. æ³¨å†Œä¸ƒç‰›äº‘è´¦å·ï¼šhttps://portal.qiniu.com/
2. åˆ›å»ºå­˜å‚¨ç©ºé—´
3. è·å– AccessKey å’Œ SecretKey

### 3. å£°ç½‘ï¼ˆéŸ³è§†é¢‘ï¼‰

```properties
# config.properties
agora.app_iD=ä½ çš„AppID
agora.app_certificate=ä½ çš„è¯ä¹¦
```

**è·å–æ–¹å¼ï¼š**
1. æ³¨å†Œå£°ç½‘è´¦å·ï¼šhttps://console.agora.io/
2. åˆ›å»ºé¡¹ç›®
3. è·å– AppID å’Œè¯ä¹¦

### 4. ç½‘æ˜“äº‘ä¿¡ï¼ˆçŸ­ä¿¡ï¼‰

```properties
# config.properties
netEaseAppKey=ä½ çš„AppKey
netEaseAppSecret=ä½ çš„AppSecret
netEaseSmsAppKey=ä½ çš„çŸ­ä¿¡AppKey
netEaseSmsAppSecret=ä½ çš„çŸ­ä¿¡AppSecret
smsTemplateid=ä½ çš„çŸ­ä¿¡æ¨¡æ¿ID
```

**è·å–æ–¹å¼ï¼š**
1. æ³¨å†Œç½‘æ˜“äº‘ä¿¡è´¦å·ï¼šhttps://id.163yun.com/
2. åˆ›å»ºåº”ç”¨
3. å¼€é€šçŸ­ä¿¡æœåŠ¡
4. åˆ›å»ºçŸ­ä¿¡æ¨¡æ¿

### 5. Ping++ï¼ˆæ”¯ä»˜ï¼‰

```yaml
# xchat.manager.yml
external:
  pingxx:
    appId: app_xxxxxxxx
    apiKey: sk_live_xxxxxxxx
    publicKey: -----BEGIN PUBLIC KEY-----...-----END PUBLIC KEY-----
    privateKeyPath: /path/to/pingxx_rsa_private_key.pem
```

**è·å–æ–¹å¼ï¼š**
1. æ³¨å†Œ Ping++ è´¦å·ï¼šhttps://www.pingxx.com/
2. åˆ›å»ºåº”ç”¨
3. é…ç½®æ”¯ä»˜æ¸ é“ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ç­‰ï¼‰
4. ä¸‹è½½ç§é’¥æ–‡ä»¶

### 6. æå…‰æ¨é€ï¼ˆJPushï¼‰

```yaml
# xchat.manager.yml
external:
  jpush:
    appKey: ä½ çš„AppKey
    secret: ä½ çš„MasterSecret
```

**è·å–æ–¹å¼ï¼š**
1. æ³¨å†Œæå…‰è´¦å·ï¼šhttps://www.jiguang.cn/
2. åˆ›å»ºåº”ç”¨
3. è·å– AppKey å’Œ MasterSecret

### 7. å³æ„ï¼ˆZegoï¼‰

```yaml
# xchat.manager.yml
external:
  zego:
    appId: ä½ çš„AppID
    secret: ä½ çš„Secret
    tokenUrl: https://liveroom-api.zego.im/cgi/token
```

**è·å–æ–¹å¼ï¼š**
1. æ³¨å†Œå³æ„è´¦å·ï¼šhttps://www.zego.im/
2. åˆ›å»ºåº”ç”¨
3. è·å– AppID å’Œ Secret

---

## ğŸ“¦ é™„å½•Eï¼šæ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. MySQL ä¼˜åŒ–

```sql
-- åˆ›å»ºç´¢å¼•
ALTER TABLE users ADD INDEX idx_erban_no (erban_no);
ALTER TABLE users ADD INDEX idx_phone (phone);
ALTER TABLE room ADD INDEX idx_uid (uid);
ALTER TABLE gift_send_record ADD INDEX idx_uid_create_time (uid, create_time);
ALTER TABLE gift_send_record ADD INDEX idx_room_uid_create_time (room_uid, create_time);

-- é…ç½®ä¼˜åŒ– (my.cnf)
[mysqld]
max_connections = 500
innodb_buffer_pool_size = 2G
innodb_log_file_size = 256M
query_cache_size = 128M
query_cache_type = 1
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

### 2. Redis ä¼˜åŒ–

```conf
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec
```

### 3. JVM ä¼˜åŒ–

```bash
# å¯åŠ¨å‚æ•°
java -server \
  -Xms2g -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/labei/heapdump.hprof \
  -Dfile.encoding=UTF-8 \
  -jar appservice.jar
```

### 4. Nginx ä¼˜åŒ–

```nginx
# nginx.conf
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 10240;
    use epoll;
}

http {
    # å¼€å¯ gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1k;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;

    # ç¼“å­˜é…ç½®
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

    # è¿æ¥è¶…æ—¶
    keepalive_timeout 65;
    client_max_body_size 50m;
}
```

### 5. Node.js ä¼˜åŒ–

```javascript
// imsvr å¯åŠ¨å‚æ•°
pm2 start im-svr.js \
  --name "im-svr" \
  --instances 4 \
  --exec-mode cluster \
  --max-memory-restart 1G \
  -- 3000
```

---

## ğŸ“¦ é™„å½•Fï¼šç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—é…ç½®

#### Spring Boot æ—¥å¿— (logback.xml)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/var/log/labei/api.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>/var/log/labei/api.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="FILE" />
    </root>
</configuration>
```

#### Node.js æ—¥å¿—

```javascript
// imsvr/libs/logger.js
const winston = require('winston');

const logger = winston.createLogger({
    level: 'info',
    format: winston.format.json(),
    transports: [
        new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
        new winston.transports.File({ filename: 'logs/combined.log' })
    ]
});
```

### 2. ç›‘æ§æŒ‡æ ‡

#### ç³»ç»Ÿç›‘æ§

```bash
# CPUã€å†…å­˜ã€ç£ç›˜ç›‘æ§
top
htop
free -h
df -h

# ç½‘ç»œç›‘æ§
netstat -an | grep ESTABLISHED | wc -l
iftop
```

#### åº”ç”¨ç›‘æ§

```bash
# Java åº”ç”¨
jps -l
jstat -gcutil <pid> 1000
jmap -heap <pid>

# Node.js åº”ç”¨
pm2 monit
pm2 logs
```

### 3. å‘Šè­¦é…ç½®

#### é’‰é’‰æœºå™¨äººå‘Šè­¦

```java
// å‘é€é’‰é’‰å‘Šè­¦
public void sendDingTalkAlert(String message) {
    String webhook = "https://oapi.dingtalk.com/robot/send?access_token=xxx";
    JSONObject json = new JSONObject();
    json.put("msgtype", "text");
    JSONObject text = new JSONObject();
    text.put("content", "ã€æ‹‰è´æ˜Ÿçƒå‘Šè­¦ã€‘" + message);
    json.put("text", text);

    HttpUtil.post(webhook, json.toString());
}
```

---

## ğŸ“¦ é™„å½•Gï¼šå®‰å…¨åŠ å›º

### 1. æ•°æ®åº“å®‰å…¨

```sql
-- åˆ é™¤åŒ¿åç”¨æˆ·
DELETE FROM mysql.user WHERE User='';

-- åˆ é™¤æµ‹è¯•æ•°æ®åº“
DROP DATABASE IF EXISTS test;

-- ç¦æ­¢ root è¿œç¨‹ç™»å½•
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```

### 2. Redis å®‰å…¨

```conf
# redis.conf
# ç»‘å®šæœ¬åœ°åœ°å€
bind 127.0.0.1

# è®¾ç½®å¯†ç 
requirepass å¼ºå¯†ç 

# ç¦ç”¨å±é™©å‘½ä»¤
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
```

### 3. Nginx å®‰å…¨

```nginx
# éšè—ç‰ˆæœ¬å·
server_tokens off;

# é˜²æ­¢ç‚¹å‡»åŠ«æŒ
add_header X-Frame-Options "SAMEORIGIN";

# XSS é˜²æŠ¤
add_header X-XSS-Protection "1; mode=block";

# é˜²æ­¢ MIME ç±»å‹å—…æ¢
add_header X-Content-Type-Options "nosniff";

# é™æµé…ç½®
limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
limit_req zone=one burst=20 nodelay;
```

### 4. åº”ç”¨å®‰å…¨

```java
// SQL æ³¨å…¥é˜²æŠ¤ - ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
String sql = "SELECT * FROM users WHERE uid = ?";
PreparedStatement pstmt = conn.prepareStatement(sql);
pstmt.setLong(1, uid);

// XSS é˜²æŠ¤ - è¿‡æ»¤ç”¨æˆ·è¾“å…¥
String safeContent = StringEscapeUtils.escapeHtml4(userInput);

// CSRF é˜²æŠ¤ - ä½¿ç”¨ Token
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());
    }
}
```

---

## ğŸ“¦ é™„å½•Hï¼šå¤‡ä»½å’Œæ¢å¤

### 1. MySQL å¤‡ä»½

```bash
#!/bin/bash
# backup-mysql.sh

BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="root"
MYSQL_PASS="ä½ çš„å¯†ç "

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -u$MYSQL_USER -p$MYSQL_PASS --single-transaction --routines --triggers labei > $BACKUP_DIR/labei_$DATE.sql

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_DIR/labei_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "MySQL backup completed: labei_$DATE.sql.gz"
```

### 2. Redis å¤‡ä»½

```bash
#!/bin/bash
# backup-redis.sh

BACKUP_DIR="/backup/redis"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# è§¦å‘ Redis ä¿å­˜
redis-cli -a ä½ çš„å¯†ç  BGSAVE

# ç­‰å¾…ä¿å­˜å®Œæˆ
sleep 5

# å¤åˆ¶ RDB æ–‡ä»¶
cp /var/lib/redis/dump.rdb $BACKUP_DIR/dump_$DATE.rdb

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "dump_*.rdb" -mtime +7 -delete

echo "Redis backup completed: dump_$DATE.rdb"
```

### 3. æ–‡ä»¶å¤‡ä»½

```bash
#!/bin/bash
# backup-files.sh

BACKUP_DIR="/backup/files"
DATE=$(date +%Y%m%d_%H%M%S)
SOURCE_DIR="/path/to/labei"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æºç å’Œé…ç½®
tar -czf $BACKUP_DIR/labei_$DATE.tar.gz \
  --exclude='node_modules' \
  --exclude='target' \
  --exclude='logs' \
  $SOURCE_DIR

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "labei_*.tar.gz" -mtime +30 -delete

echo "Files backup completed: labei_$DATE.tar.gz"
```

### 4. å®šæ—¶å¤‡ä»½

```bash
# æ·»åŠ åˆ° crontab
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ MySQL
0 2 * * * /path/to/backup-mysql.sh

# æ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½ Redis
0 3 * * * /path/to/backup-redis.sh

# æ¯å‘¨æ—¥å‡Œæ™¨4ç‚¹å¤‡ä»½æ–‡ä»¶
0 4 * * 0 /path/to/backup-files.sh
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2025-11-10
**é€‚ç”¨ç‰ˆæœ¬ï¼š** æ‹‰è´æ˜Ÿçƒå®Œæ•´æºç 
**æ€»é¡µæ•°ï¼š** å®Œæ•´éƒ¨ç½²æŒ‡å—

