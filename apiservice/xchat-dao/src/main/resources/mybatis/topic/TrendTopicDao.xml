<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.juxiao.xchat.dao.topic.TrendTopicDao" >
  <resultMap id="BaseResultMap" type="com.juxiao.xchat.dao.topic.domain.TrendTopic" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <id column="uid" property="uid" jdbcType="BIGINT" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="themeid" property="themeid" jdbcType="BIGINT" />
      <result column="erban_no" property="erbanNo" jdbcType="BIGINT" />
      <result column="nick" property="nick" jdbcType="VARCHAR"/>
      <result column="gender" property="gender" jdbcType="TINYINT"/>
    <result column="commentnum" property="commentnum" jdbcType="INTEGER" />
    <result column="visitnum" property="visitnum" jdbcType="INTEGER" />
    <result column="state" property="state" jdbcType="VARCHAR" />
    <result column="remarks" property="remarks" jdbcType="VARCHAR" />
    <result column="voice_url" property="voiceUrl" jdbcType="VARCHAR" />
    <result column="picture_url" property="pictureUrl" jdbcType="VARCHAR" />
    <result column="praisenum" property="praisenum" jdbcType="INTEGER" />
    <result column="permission_type" property="permissionType" jdbcType="TINYINT"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
      <result column="audio_dura" property="audioDura" jdbcType="INTEGER" />
  </resultMap>

    <resultMap id="BaseResultMap2" type="com.juxiao.xchat.dao.topic.dto.TrendTopicDTO" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <id column="uid" property="uid" jdbcType="BIGINT" />
        <result column="name" property="name" jdbcType="VARCHAR" />
        <result column="themeid" property="themeid" jdbcType="BIGINT" />
        <result column="erban_no" property="erbanNo" jdbcType="BIGINT" />
        <result column="nick" property="nick" jdbcType="VARCHAR"/>
        <result column="gender" property="gender" jdbcType="TINYINT"/>
        <result column="commentnum" property="commentnum" jdbcType="INTEGER" />
        <result column="visitnum" property="visitnum" jdbcType="INTEGER" />
        <result column="state" property="state" jdbcType="VARCHAR" />
        <result column="remarks" property="remarks" jdbcType="VARCHAR" />
        <result column="voice_url" property="voiceUrl" jdbcType="VARCHAR" />
        <result column="picture_url" property="pictureUrl" jdbcType="VARCHAR" />
        <result column="praisenum" property="praisenum" jdbcType="INTEGER" />
        <result column="permission_type" property="permissionType" jdbcType="TINYINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
        <result column="audio_dura" property="audioDura" jdbcType="INTEGER" />
        <result column="avatar" property="avatar" jdbcType="VARCHAR" />
         <result column="themeName" property="themeName" jdbcType="VARCHAR" />
    </resultMap>

  <sql id="Base_Column_List" >
    id, uid,name, themeid,erban_no,nick,gender,commentnum, visitnum, state, remarks,voice_url,picture_url,praisenum,permission_type,create_time, update_time,audio_dura
  </sql>
<sql id="topic_users_theme">
    trend_topic.id,
    trend_topic.uid,
    trend_topic.name,
    trend_topic.themeid,
    users.erban_no,
    users.nick,
    users.gender,
    users.avatar,
    trend_topic.commentnum,
    trend_topic.visitnum,
    trend_topic.state,
    trend_topic.remarks,
    trend_topic.voice_url,
    trend_topic.picture_url,
    trend_topic.praisenum,
    trend_topic.permission_type,
    trend_topic.create_time,
    trend_topic.update_time,
    trend_topic.audio_dura,
    theme.name as themeName
</sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from trend_topic
    where id = #{id,jdbcType=BIGINT}
  </select>

  <select id="listTopic" resultMap="BaseResultMap2">
    SELECT <include refid="topic_users_theme"/>
    FROM trend_topic
    join users on trend_topic.uid=users.uid
    left join theme on theme.id=trend_topic.themeid and theme.state='1'
    <where>
      <if test="query.id != null">
        AND trend_topic.id=#{query.id}
      </if>
      <if test="query.themeid != null">
        AND trend_topic.themeid=#{query.themeid}
      </if>
      <if test="query.state != null">
        AND trend_topic.state=#{query.state}
      </if>
      <if test="query.createTime != null">
        AND trend_topic.create_time &gt; #{query.createTime}
      </if>
      <if test="query.remarks != null">
        AND trend_topic.remarks like concat('%',#{query.remarks},'%')
      </if>
      <if test="query.name != null">
        AND trend_topic.name like concat('%',#{query.name},'%')
      </if>
      and (
      trend_topic.permission_type=1
      or
      ( trend_topic.permission_type=2 and
        (
          (exists(select 1 from fans where fans.like_uid=trend_topic.uid and fans.liked_uid=#{query.uid})
          and exists(select 1 from fans where fans.like_uid=#{query.uid} and fans.liked_uid=trend_topic.uid)
          ) or trend_topic.uid=#{query.uid}
        )
      )
      or (trend_topic.permission_type=3 and trend_topic.uid=#{query.uid})
      )
      and trend_topic.state='1'
    </where>
    <trim prefix="LIMIT ">
      <if test="page!= null"> #{page.bottom},#{page.pageSize}</if>
    </trim>
  </select>
  <select id="getSize" resultType="java.lang.Long">
    SELECT count(1)
    FROM trend_topic
    join users on trend_topic.uid=users.uid
    left join theme on theme.id=trend_topic.themeid and theme.state='1'
    <where>
      <if test="query.id != null">
        AND trend_topic.id=#{query.id}
      </if>
      <if test="query.themeid != null">
        AND trend_topic.themeid=#{query.themeid}
      </if>
      <if test="query.state != null">
        AND trend_topic.state=#{query.state}
      </if>
      <if test="query.createTime != null">
        AND trend_topic.create_time &gt; #{query.createTime}
      </if>
      <if test="query.remarks != null">
        AND trend_topic.remarks like concat('%',#{query.remarks},'%')
      </if>
      <if test="query.name != null">
        AND trend_topic.name like concat('%',#{query.name},'%')
      </if>
      and (
          trend_topic.permission_type=1
          or
          ( trend_topic.permission_type=2 and
            (
              (exists(select 1 from fans where fans.like_uid=trend_topic.uid and fans.liked_uid=#{query.uid})
              and exists(select 1 from fans where fans.like_uid=#{query.uid} and fans.liked_uid=trend_topic.uid)
              ) or trend_topic.uid=#{query.uid}
            )
          )
          or (trend_topic.permission_type=3 and trend_topic.uid=#{query.uid})
          )
        and trend_topic.state='1'
    </where>
  </select>
  <select id="topTopic" resultMap="BaseResultMap2">
    select
    <include refid="topic_users_theme" />
      from trend_topic
      join users on trend_topic.uid=users.uid
      left join theme on theme.id=trend_topic.themeid and theme.state='1'
      where (trend_topic.permission_type=1
      or
      ( trend_topic.permission_type=2 and
      (
      (exists(select 1 from fans where fans.like_uid=trend_topic.uid and fans.liked_uid=#{uid})
      and exists(select 1 from fans where fans.like_uid=#{uid} and fans.liked_uid=trend_topic.uid)
      ) or trend_topic.uid=#{uid}
      )
      )
      or (trend_topic.permission_type=3 and trend_topic.uid=#{uid})
      )
      and trend_topic.state='1'
      order by trend_topic.commentnum desc
      limit #{bottom},#{num}
  </select>
  <select id="topNew" resultMap="BaseResultMap2">
    select
    <include refid="topic_users_theme" />
      from trend_topic
      join users on trend_topic.uid=users.uid
      left join theme on theme.id=trend_topic.themeid and theme.state='1'
      where trend_topic.state='1' and
      ( trend_topic.permission_type=1
      or
      ( trend_topic.permission_type=2 and
      (
      (exists(select 1 from fans where fans.like_uid=trend_topic.uid and fans.liked_uid=#{uid})
      and exists(select 1 from fans where fans.like_uid=#{uid} and fans.liked_uid=trend_topic.uid)
      ) or trend_topic.uid=#{uid}
      )
      )
      or (trend_topic.permission_type=3 and trend_topic.uid=#{uid})
      )
      order by trend_topic.create_time desc
      <trim prefix="LIMIT ">
      <if test="page!= null"> #{page.bottom},#{page.pageSize}</if>
    </trim>
  </select>

  <select id="likedTopic" resultMap="BaseResultMap2">
    select
    <include refid="topic_users_theme" />
    from trend_topic
    join users on trend_topic.uid=users.uid
    join fans on fans.liked_uid=trend_topic.uid
    left join theme on theme.id=trend_topic.themeid and theme.state='1'
    where fans.like_uid=#{uid}
    and trend_topic.state='1'
    and (
      trend_topic.permission_type=1 or
      (trend_topic.permission_type=2 and (EXISTS ( SELECT 1 FROM fans WHERE fans.liked_uid =#{uid} AND fans.like_uid = trend_topic.uid )))
    )
    <trim prefix="LIMIT ">
      <if test="page!= null"> #{page.bottom},#{page.pageSize}</if>
    </trim>
  </select>
    <select id="recommend" resultMap="BaseResultMap2">
        select
        <include refid="topic_users_theme" />
        from trend_topic
        join users on trend_topic.uid=users.uid
        left join theme on theme.id=trend_topic.themeid and theme.state='1'
        where trend_topic.state='1' and
        (trend_topic.permission_type=1
        or
        ( trend_topic.permission_type=2 and
        (
        (exists(select 1 from fans where fans.like_uid=trend_topic.uid and fans.liked_uid=#{uid})
        and exists(select 1 from fans where fans.like_uid=#{uid} and fans.liked_uid=trend_topic.uid)
        ) or trend_topic.uid=#{uid}
        )
        )
        or (trend_topic.permission_type=3 and trend_topic.uid=#{uid})
        )
        order by trend_topic.call_time desc
        <trim prefix="LIMIT ">
            <if test="page!= null"> #{page.bottom},#{page.pageSize}</if>
        </trim>
    </select>
  <select id="getById" resultMap="BaseResultMap2">
    select
    <include refid="topic_users_theme" />
    from trend_topic
    join users on trend_topic.uid=users.uid
    left join theme on theme.id=trend_topic.themeid and theme.state='1'
    where trend_topic.id=#{id}
      and trend_topic.state='1'
      and (
          trend_topic.permission_type=1
          or
          ( trend_topic.permission_type=2 and
          (
          (exists(select 1 from fans where fans.like_uid=trend_topic.uid and fans.liked_uid=#{uid})
          and exists(select 1 from fans where fans.like_uid=#{uid} and fans.liked_uid=trend_topic.uid)
          ) or trend_topic.uid=#{uid}
          )
          )
          or (trend_topic.permission_type=3 and trend_topic.uid=#{uid})
    )
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    delete from trend_topic
    where id = #{id,jdbcType=BIGINT}
  </delete>

  <insert id="insert" parameterType="com.juxiao.xchat.dao.topic.domain.TrendTopic" >
    insert into trend_topic (id,uid, name, themeid, erban_no,nick,gender,
      commentnum, visitnum, state, 
      remarks, praisenum,audio_dura, voice_url, picture_url,permission_type, create_time, update_time
      )
    values (#{id,jdbcType=BIGINT}, #{uid,jdbcType=BIGINT},#{name,jdbcType=VARCHAR}, #{themeid,jdbcType=BIGINT},
    #{erbanNo,jdbcType=BIGINT},#{nick,jdbcType=VARCHAR}, #{gender,jdbcType=TINYINT},
      #{commentnum,jdbcType=INTEGER}, #{visitnum,jdbcType=INTEGER}, #{state,jdbcType=VARCHAR}, 
      #{remarks,jdbcType=VARCHAR}, #{praisenum,jdbcType=INTEGER}, #{audioDura,jdbcType=INTEGER},#{voiceUrl,jdbcType=VARCHAR},#{pictureUrl,jdbcType=VARCHAR},#{permissionType,jdbcType=TINYINT},#{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.juxiao.xchat.dao.topic.domain.TrendTopic" >
    insert into trend_topic
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="uid != null" >
        uid,
      </if>
      <if test="name != null" >
        name,
      </if>
      <if test="themeid != null" >
        themeid,
      </if>
        <if test="erbanNo != null" >
            erban_no,
        </if>
        <if test="nick != null" >
            nick,
        </if>
        <if test="gender != null" >
            gender,
        </if>
      <if test="commentnum != null" >
        commentnum,
      </if>
      <if test="visitnum != null" >
        visitnum,
      </if>
      <if test="state != null" >
        state,
      </if>
      <if test="remarks != null" >
        remarks,
      </if>
      <if test="praisenum != null" >
        praisenum,
      </if>
        <if test="audioDura != null" >
            audio_dura,
        </if>
      <if test="voiceUrl != null" >
        voice_url,
      </if>
      <if test="pictureUrl != null" >
        picture_url,
      </if>
      <if test="permissionType != null" >
        permission_type,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="uid != null" >
        #{uid,jdbcType=BIGINT},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="themeid != null" >
        #{themeid,jdbcType=BIGINT},
      </if>
        <if test="erbanNo != null" >
            #{erbanNo,jdbcType=BIGINT},
        </if>
        <if test="nick != null" >
            #{nick,jdbcType=VARCHAR},
        </if>
        <if test="gender != null" >
            #{gender,jdbcType=TINYINT},
        </if>
      <if test="commentnum != null" >
        #{commentnum,jdbcType=INTEGER},
      </if>
      <if test="visitnum != null" >
        #{visitnum,jdbcType=INTEGER},
      </if>
      <if test="state != null" >
        #{state,jdbcType=VARCHAR},
      </if>
      <if test="remarks != null" >
        #{remarks,jdbcType=VARCHAR},
      </if>
      <if test="praisenum != null" >
        #{praisenum,jdbcType=INTEGER},
      </if>
        <if test="audioDura != null" >
          #{audioDura,jdbcType=INTEGER},
        </if>
      <if test="voiceUrl != null" >
        #{voiceUrl,jdbcType=VARCHAR},
      </if>
      <if test="pictureUrl != null" >
        #{pictureUrl,jdbcType=VARCHAR},
      </if>
      <if test="permissionType != null" >
        #{permissionType,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>


  <update id="updateByPrimaryKeySelective" parameterType="com.juxiao.xchat.dao.topic.domain.TrendTopic" >
    update trend_topic
    <set >
      <if test="uid != null" >
            uid = #{uid,jdbcType=BIGINT},
      </if>
      <if test="name != null" >
        name = #{name,jdbcType=VARCHAR},
      </if>

      <if test="themeid != null" >
        themeid = #{themeid,jdbcType=BIGINT},
      </if>
      <if test="erbanNo != null" >
            erban_no = #{erbanNo,jdbcType=BIGINT},
       </if>
        <if test="nick != null" >
            nick = #{nick,jdbcType=BIGINT},
        </if>
        <if test="gender != null" >
            gender = #{gender,jdbcType=TINYINT},
        </if>
      <if test="commentnum != null" >
        commentnum = #{commentnum,jdbcType=INTEGER},
      </if>
      <if test="visitnum != null" >
        visitnum = #{visitnum,jdbcType=INTEGER},
      </if>
      <if test="state != null" >
        state = #{state,jdbcType=VARCHAR},
      </if>
      <if test="remarks != null" >
        remarks = #{remarks,jdbcType=VARCHAR},
      </if>
      <if test="praisenum != null" >
        praisenum=#{praisenum,jdbcType=INTEGER},
    </if>
        <if test="audioDura != null" >
            audio_dura=#{audioDura,jdbcType=INTEGER},
        </if>
      <if test="voiceUrl != null" >
        voice_url= #{voiceUrl,jdbcType=VARCHAR},
      </if>
      <if test="pictureUrl != null" >
        picture_url= #{pictureUrl,jdbcType=VARCHAR},
      </if>
      <if test="permissionType != null" >
        permission_type= #{permissionType,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>

  <update id="updateByPrimaryKey" parameterType="com.juxiao.xchat.dao.topic.domain.TrendTopic" >
    update trend_topic
    set uid = #{uid,jdbcType=BIGINT},
      name = #{name,jdbcType=VARCHAR},
      themeid = #{themeid,jdbcType=BIGINT},
      erban_no = #{erbanNo,jdbcType=BIGINT},
      nick= #{nick,jdbcType=VARCHAR},
      gender=#{gender,jdbcType=TINYINT},
      commentnum = #{commentnum,jdbcType=INTEGER},
      visitnum = #{visitnum,jdbcType=INTEGER},
      state = #{state,jdbcType=VARCHAR},
      remarks = #{remarks,jdbcType=VARCHAR},
      praisenum=#{praisenum,jdbcType=INTEGER},
      audio_dura=#{audioDura,jdbcType=INTEGER},
      voice_url= #{voiceUrl,jdbcType=VARCHAR},
      picture_url= #{pictureUrl,jdbcType=VARCHAR},
      permission_type= #{permissionType,jdbcType=TINYINT},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP}
    where id = #{id,jdbcType=BIGINT}
  </update>

  <update id="upByComment">
    update trend_topic set commentnum=commentnum+1 where id=#{topicid}
  </update>
  <update id="deByComment">
    update trend_topic set commentnum=commentnum-1 where id=#{topicid}
  </update>
  <update id="upByPraise">
    update trend_topic set praisenum=praisenum+1 where id=#{topicid}
  </update>
    <update id="deByPraise">
    update trend_topic set praisenum=praisenum-1 where id=#{topicid}
   </update>
    <update id="upByVisis">
      update trend_topic set visitnum=visitnum+1 where id=#{topicid}
    </update>
    <update id="updateCallTime">
        update trend_topic set call_time=#{callTime} where id=#{topicid}
    </update>
</mapper>