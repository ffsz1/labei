<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.juxiao.xchat.dao.user.UserDrawGiftRecordDao">

    <insert id="save" parameterType="com.juxiao.xchat.dao.user.domain.UserDrawGiftRecordDO" useGeneratedKeys="true" keyProperty="recordId">
        <trim prefix="INSERT INTO `user_draw_gift_record` (" suffix=")" suffixOverrides=",">
            <if test="uid != null">uid,</if>
            <if test="roomId != null">room_id,</if>
            <if test="giftId != null">gift_id,</if>
            <if test="num != null">num,</if>
            <if test="type != null">`type`,</if>
            <if test="doDrawType != null">`do_draw_type`,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="uid != null">#{uid,jdbcType=BIGINT},</if>
            <if test="roomId != null">#{roomId,jdbcType=BIGINT},</if>
            <if test="giftId != null">#{giftId,jdbcType=INTEGER},</if>
            <if test="num != null">#{num,jdbcType=INTEGER},</if>
            <if test="type != null">#{type,jdbcType=TINYINT},</if>
            <if test="doDrawType != null">#{doDrawType,jdbcType=TINYINT},</if>
            <if test="createTime != null">#{createTime,jdbcType=TIMESTAMP},</if>
        </trim>
    </insert>

    <select id="listRoomDraw" parameterType="com.juxiao.xchat.dao.user.query.DrawGiftRecordQuery"  resultType="com.juxiao.xchat.dao.item.dto.RoomDrawRecordDTO">
        <![CDATA[
        SELECT
            ( COUNT( 1 ) * 20 ) AS totalGoldNum,
            COUNT( 1 ) AS frequency,
            DATE_FORMAT( r.create_time, '%Y-%m-%d' ) AS createTime
        FROM
            user_draw_gift_record r
        WHERE
            r.`room_id` = #{roomId}
            AND r.`create_time` > #{beginDate}
        GROUP BY
            DATE_FORMAT( r.`create_time`, '%Y-%m-%d' )
        ORDER BY
            r.`create_time` DESC,
            r.`uid` DESC;
        ]]>
    </select>

    <insert id="saveMany" parameterType="list" useGeneratedKeys="true" keyProperty="recordId">
        <trim prefix="INSERT INTO `user_draw_gift_record` (" suffix=") VALUES" suffixOverrides=",">
            uid, room_id, gift_id, num, `type`, create_time,
        </trim>
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.uid}, #{item.roomId}, #{item.giftId}, #{item.num}, #{item.type}, #{item.createTime})
        </foreach>
    </insert>

    <select id="listRoomRankByGiftType" resultType="com.juxiao.xchat.dao.user.domain.UserDrawGiftRankDO">
        <![CDATA[
        SELECT
            a.uid,
            u.erban_no AS erbanNo,
            u.nick,
            u.gender,
            u.avatar,
            0 AS experLevel,
            0 AS charmLevel,
            SUM( b.gold_price * a.gift_num ) AS tol
        FROM
            bill_gift_draw a
            INNER JOIN users u ON a.uid = u.uid
            INNER JOIN gift b ON a.gift_id = b.gift_id
        WHERE
            b.gift_type = #{giftType}
            AND a.create_time BETWEEN #{startDate}
            AND #{endDate}
        GROUP BY
            a.uid
        ORDER BY
            tol DESC
            LIMIT 20
        ]]>
    </select>

<!--    SELECT-->
<!--    ( COUNT( 1 ) * 20 ) AS totalGoldNum,-->
<!--    COUNT( 1 ) AS frequency,-->
<!--    DATE_FORMAT( r.create_time, '%Y-%m-%d' ) AS createTime-->
<!--    FROM-->
<!--    user_draw_gift_record r-->
<!--    WHERE-->
<!--    r.`room_id` = #{roomId}-->
<!--    AND r.`create_time` > #{beginDate}-->
<!--    GROUP BY-->
<!--    DATE_FORMAT( r.`create_time`, '%Y-%m-%d' )-->
<!--    ORDER BY-->
<!--    r.`create_time` DESC,-->
<!--    r.`uid` DESC;-->

</mapper>